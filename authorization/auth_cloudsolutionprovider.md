# <a name="call-microsoft-graph-from-a-cloud-solution-provider-application-preview"></a><span data-ttu-id="76623-101">Вызов Microsoft Graph из приложения поставщика облачных решений (предварительная версия)</span><span class="sxs-lookup"><span data-stu-id="76623-101">Call Microsoft Graph from a Cloud Solution Provider application (preview)</span></span>

> <span data-ttu-id="76623-p101">**Примечание.** Эта статья касается **только** разработчиков приложений CSP. С помощью [программы для поставщиков облачных решений (Майкрософт)](https://partner.microsoft.com/ru-RU/cloud-solution-provider) партнеры корпорации Майкрософт могут перепродавать службы Microsoft Online и управлять такими службами.</span><span class="sxs-lookup"><span data-stu-id="76623-p101">**Note:** This topic applies **only** to Microsoft Cloud Solution Provider (CSP) application developers. The [Microsoft Cloud Solution Provider (CSP)](https://partner.microsoft.com/ru-RU/cloud-solution-provider) program enables Microsoft’s partners to resell and manage Microsoft Online services to customers.</span></span>

<span data-ttu-id="76623-104">В этой статье описано, как обеспечить доступ приложения к данным пользователей, управляемым партнером, через Microsoft Graph с помощью [потока предоставления кодов авторизации](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-protocols-oauth-code) или [потока клиентских учетных данных между службами](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-protocols-oauth-service-to-service).</span><span class="sxs-lookup"><span data-stu-id="76623-104">This topic describes how to enable application access to partner-managed customer data via Microsoft Graph using either the [authorization code grant flow](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-protocols-oauth-code) or the [service to service client credentials flow](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-protocols-oauth-service-to-service).</span></span>

<span data-ttu-id="76623-105">**Важно!** Вызов Microsoft Graph из приложения CSP поддерживается только для ресурсов каталога (например, **user**, **group**, **device**, **organization**) и ресурсов [Intune](..\api-reference\beta\resources\intune_graph_overview.md).</span><span class="sxs-lookup"><span data-stu-id="76623-105">**Important:** Calling Microsoft Graph from a CSP application is only supported for directory resources (such as **user**, **group**,**device**, **organization**) and [Intune](..\api-reference\beta\resources\intune_graph_overview.md) resources.</span></span>

## <a name="what-is-a-partner-managed-application"></a><span data-ttu-id="76623-106">Приложение, управляемое партнером</span><span class="sxs-lookup"><span data-stu-id="76623-106">What is a partner-managed application</span></span>

<span data-ttu-id="76623-p102">С помощью программы CSP партнеры корпорации Майкрософт могут перепродавать службы Microsoft Online Services (например, Office 365, Microsoft Azure и CRM Online) и управлять такими службами. Управление службами пользователей выполняется с помощью делегированных полномочий администратора, таким образом, назначенные партнеры-пользователи (известные как агенты) смогут получить доступ к средам пользователей и настроить их.</span><span class="sxs-lookup"><span data-stu-id="76623-p102">The CSP program enables Microsoft’s partners to resell and manage Microsoft Online Services (such as Office 365, Microsoft Azure, and CRM Online) to customers. Management of customer services is done through Delegated Admin Privileges, which enables designated partner users (known as agents) to access and configure their customers’ environments.</span></span>

<span data-ttu-id="76623-p103">Кроме того, партнер-разработчик может создать **приложение, управляемое партнером**, для управления службами Майкрософт пользователя. Приложения, управляемые партнерами, часто называются *приложениями с заранее предоставленным доступом*, так как все пользователи дают соответствующее разрешение автоматически. Это означает, что конечные пользователи клиентов могут работать в приложениях, управляемых партнерами, не предоставляя согласия. Приложения, управляемые партнерами, наследуют делегированные полномочия администратора, поэтому агенты партнера тоже получат привилегированный доступ к данным пользователей через такое приложение.</span><span class="sxs-lookup"><span data-stu-id="76623-p103">Additionally, as a partner developer, you can build a **partner-managed app** to manage your customers' Microsoft services. Partner-managed apps are often called *pre-consented* apps because all your customers are automatically pre-consented for your partner-managed apps. This means when a user from one of your customer tenants uses one of your partner-managed apps, the user can use it without being prompted to give consent. Partner-managed apps also inherit Delegated Admin Privileges, so your partner agents can also get privileged access to your customers through your partner-managed application.</span></span>

## <a name="how-to-set-up-a-partner-managed-application"></a><span data-ttu-id="76623-113">Настройка приложения, управляемого партнером</span><span class="sxs-lookup"><span data-stu-id="76623-113">How to set-up a partner-managed application</span></span>

<span data-ttu-id="76623-p104">Считается, что приложение *управляется партнером*, если ему предоставлены расширенные разрешения на доступ к данным пользователя. Обратите внимание на то, что управляемые партнером приложения можно настроить *только* для клиентов партнеров.</span><span class="sxs-lookup"><span data-stu-id="76623-p104">An application is viewed as *partner-managed* when it is granted elevated permissions to access your customers' data. Note that partner-managed apps can *only* be configured on Partner tenants.</span></span>

<span data-ttu-id="76623-116">Описанные здесь первые шаги похожи на большинство аналогичных действий по регистрации и настройке мультитенантного приложения.</span><span class="sxs-lookup"><span data-stu-id="76623-116">The initial steps required here follow most of the same steps used to register and configure a multi-tenant application:</span></span>

1. <span data-ttu-id="76623-p105">[Зарегистрируйте приложение](https://docs.microsoft.com/ru-RU/azure/active-directory/active-directory-app-registration) в клиенте партнера на [портале Azure](https://portal.azure.com). Настройте приложение как [мультитенантное](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-devhowto-multi-tenant-overview#update-registration-to-be-multi-tenant), чтобы партнер мог им управлять. Если приложение развернуто и продается в нескольких географических регионах, это приложение нужно зарегистрировать в каждом из них, как описано <a href="#region">здесь</a>.</span><span class="sxs-lookup"><span data-stu-id="76623-p105">[Register your application](https://docs.microsoft.com/ru-RU/azure/active-directory/active-directory-app-registration) in your Partner tenant using the [Azure Portal](https://portal.azure.com). To function as a partner-managed app, an application must be configured as a [multi-tenant app](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-devhowto-multi-tenant-overview#update-registration-to-be-multi-tenant). Additionally, if your app is deployed and sold in multiple geographic regions you will need to register your app in each of those regions as described <a href="#region">here</a>.</span></span>
2. <span data-ttu-id="76623-120">Настройте мультитенантное приложение еще раз на портале Azure, указав *необходимые разрешения* и используя способ, предусматривающий минимальные привилегии.</span><span class="sxs-lookup"><span data-stu-id="76623-120">Configure your multi-tenant app, again through the Azure Portal, with the *required permissions* it needs using a least privileged approach.</span></span>
3. <span data-ttu-id="76623-p106">Предоставьте приложению, управляемому партнером, эти настроенные разрешения для всех пользователей. Для этого добавьте объект **servicePrincipal**, представляющий приложение, в группу Adminagents в клиенте партнера с помощью Azure AD PowerShell 2. Скачать и установить Azure AD PowerShell 2 можно [здесь](https://www.powershellgallery.com/packages/AzureAD).  Выполните указанные ниже шаги, чтобы найти группу Adminagents, и добавьте в нее **servicePrincipal**.</span><span class="sxs-lookup"><span data-stu-id="76623-p106">Finally grant your partner-managed app those configured permissions for all your customers. You can do this by adding the **servicePrincipal** that represents the app to the Adminagents group in your Partner tenant, using Azure AD powershell V2. You can download and install Azure AD PowerShell V2 from [here](https://www.powershellgallery.com/packages/AzureAD).  Follow these steps to find the Adminagents group, the **servicePrincipal** and add it to the group.</span></span>

    1. <span data-ttu-id="76623-125">Откройте сеанс PowerShell и подключитесь к клиенту партнера, введя учетные данные администратора в окне входа.</span><span class="sxs-lookup"><span data-stu-id="76623-125">Open a PowerShell session and connect to your partner tenant by entering your admin credentials into the sign-in window.</span></span>
    ```PowerShell
    Connect-AzureAd
    ```
    2. <span data-ttu-id="76623-126">Найдите группу, которая представляет Adminagents.</span><span class="sxs-lookup"><span data-stu-id="76623-126">Find the group that represents the Adminagents.</span></span>
    ```PowerShell
    $group = Get-AzureADGroup -Filter "displayName eq 'Adminagents'"
    ```
    3. <span data-ttu-id="76623-127">Найдите субъект-службу с тем же *appId*, что и у приложения.</span><span class="sxs-lookup"><span data-stu-id="76623-127">Find the service principal that has the same *appId* as your app.</span></span>
    ```PowerShell
    $sp = Get-AzureADServicePrincipal -Filter "appId eq '{yourAppsAppId}'"
    ```
    4. <span data-ttu-id="76623-128">Добавьте субъект-службу в группу Adminagents.</span><span class="sxs-lookup"><span data-stu-id="76623-128">Finally, add the service principal to the Adminagents group.</span></span>
    ```PowerShell
    Add-AzureADGroupMember -ObjectId $group.ObjectId -RefObjectId $sp.ObjectId
    ```

## <a name="token-acquisition-flows"></a><span data-ttu-id="76623-129">Потоки получения токенов</span><span class="sxs-lookup"><span data-stu-id="76623-129">Token acquisition flows</span></span>

<span data-ttu-id="76623-130">Потоки получения токенов для приложений, управляемых партнерами, ничем не отличаются от таковых для обычных мультитенантных приложений. Доступны [поток предоставления кодов авторизации](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-protocols-oauth-code) и [поток учетных данных клиентов между службами](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-protocols-oauth-service-to-service).</span><span class="sxs-lookup"><span data-stu-id="76623-130">Token acquisition flows for partner-managed apps - [authorization code grant flow](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-protocols-oauth-code) and [service-to-service client credentials flow](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-protocols-oauth-service-to-service) - are the same as regular multi-tenant apps.</span></span>

<span data-ttu-id="76623-p107">Помимо предварительно предоставленного доступа ко всем клиентам пользователя, приложения, управляемые партнерами, имеют одну дополнительную возможность. Благодаря таким приложениям агенты могут получать доступ к данным клиента пользователя (с помощью делегированных полномочий администратора). Принцип работы изложен ниже.</span><span class="sxs-lookup"><span data-stu-id="76623-p107">Apart from pre-consented access to all your customer tenants, partner-managed apps have one additional capability. It allows for your agents to use your app to access your customers' tenant data (using delegated admin privileges). Conceptually it works like this:</span></span>

1. <span data-ttu-id="76623-134">Агент выполняет вход в приложение с учетными данными пользователя, полученными от клиента партнера.</span><span class="sxs-lookup"><span data-stu-id="76623-134">Your agent signs in to your app with their user credentials issued from your partner tenant.</span></span>
2. <span data-ttu-id="76623-135">Приложение запрашивает маркер доступа для нужного клиента, управляемого партнером.</span><span class="sxs-lookup"><span data-stu-id="76623-135">Your app requests an access token for the intended partner-managed customer tenant.</span></span>
3. <span data-ttu-id="76623-136">Приложение использует маркер доступа для вызова Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="76623-136">Your app uses the access token to call Microsoft Graph.</span></span>

<span data-ttu-id="76623-p108">Этот способ несколько отличается от способа с использованием [потока предоставления кодов авторизации](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-protocols-oauth-code). Рассмотрим, как это выглядит на практике. Допустим, клиент партнера — *partner.com* (главный клиент для агентов), а один из клиентов — *customer.com*.</span><span class="sxs-lookup"><span data-stu-id="76623-p108">This is a slight variation on the [authorization code grant flow](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-protocols-oauth-code). To see how this would look, imagine your partner tenant is *partner.com* (which is the home tenant for your agents) and one of your customers is *customer.com*:</span></span>

1. <span data-ttu-id="76623-139">[Получите код авторизации.](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-protocols-oauth-code#request-an-authorization-code) Приложение отправляет запрос конечной точке ```/authorize```, указав ```common``` или ```partner.com``` для целевого клиента.</span><span class="sxs-lookup"><span data-stu-id="76623-139">[Acquire an authorization code:](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-protocols-oauth-code#request-an-authorization-code) Your app makes a request to the ```/authorize``` endpoint, specifying ```common``` or ```partner.com``` for the target tenant.</span></span>

   ```http
   GET https://login.microsoftonline.com/common/oauth2/authorize
   ```

2. <span data-ttu-id="76623-140">[Получите маркер доступа с помощью кода авторизации.](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-protocols-oauth-code#use-the-authorization-code-to-request-an-access-token) Отправляя запрос конечной точке ```token```, приложение должно использовать **клиент пользователя** как целевой клиент. В нашем примере указан ```customer.com```:</span><span class="sxs-lookup"><span data-stu-id="76623-140">[Aquire an access token using the authorization code:](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-protocols-oauth-code#use-the-authorization-code-to-request-an-access-token) Your app must use a **customer tenant** as the target tenant, in our example ```customer.com```, when making the request to the ```token``` endpoint:</span></span>

   ```http
   POST https://login.microsoftonline.com/customer.com/oauth2/token
   ```

3. <span data-ttu-id="76623-141">Теперь, когда у вас есть маркер доступа, вызовем Microsoft Graph, поместив маркер доступа в заголовок авторизации HTTP:</span><span class="sxs-lookup"><span data-stu-id="76623-141">Now you have an access token, call Microsoft Graph, putting the access token in the HTTP authorization header:</span></span>

    ```http
    GET https://graph.microsoft.com/beta/users
    Authorization: Bearer <token>
    ```

## <a name="register-your-app-in-the-regions-you-support"></a><span data-ttu-id="76623-142">Регистрация приложения в доступных регионах</span><span class="sxs-lookup"><span data-stu-id="76623-142">Register your app in the regions you support</span></span>
<a name="region"></a>

<span data-ttu-id="76623-p109">В настоящее время участие пользователя CSP ограничено одним регионом. Для управляемых партнерами приложений предусмотрено такое же ограничение. Это означает, что для каждого региона, где вы осуществляете продажи, нужен отдельный клиент. Например, если ваше приложение, управляемое партнером, зарегистрировано в клиенте для США, а ваш пользователь находится в ЕС, такое приложение работать не будет.  Каждый клиент регионального партнера должен обслуживать собственный набор приложений, управляемых партнером, для управления пользователями в том же регионе. При этом может потребоваться дополнительная логика в приложении, выполняющаяся до входа, чтобы можно было получить имя пользователя для входа. Необходимо выбрать удостоверение приложения, управляемого партнером в определенном регионе, для обслуживания пользователя.</span><span class="sxs-lookup"><span data-stu-id="76623-p109">CSP customer engagement is currently limited to a single region. Partner-managed applications carry the same limitation. This means you must have a separate tenant for each region you sell in. For example, if your partner-managed app is registered in a tenant in the US but your customer is in the EU – the partner-managed app will not work.  Each of your regional partner tenants must maintain their own set of partner-managed apps to manage customers within the same region. This might require additional logic in your app (prior to sign-in) to get your customers' sign-in username to decide which region-specific partner-managed app identity to use, to serve the user.</span></span>

## <a name="calling-microsoft-graph-immediately-after-customer-creation"></a><span data-ttu-id="76623-149">Вызов Microsoft Graph сразу же после создания пользователя</span><span class="sxs-lookup"><span data-stu-id="76623-149">Calling Microsoft Graph immediately after customer creation</span></span>

<span data-ttu-id="76623-p110">При создании нового пользователя с помощью [API Центра партнеров](https://partnercenter.microsoft.com/ru-RU/partner/developer) создается новый клиент пользователя. Создается также отношение партнера, поэтому вы становитесь партнером записи для этого нового клиента пользователя. Передача отношения партнера в новый клиент пользователя может длиться до 3 минут. Если ваше приложение вызовет Microsoft Graph сразу после создания, оно, скорее всего, получит сообщение об ошибке с отказом в доступе. Аналогичная задержка может возникнуть при принятии вашего приглашения существующим пользователем. Так происходит из-за того, что предварительное согласие зависит от наличия отношения партнера в клиенте пользователя.</span><span class="sxs-lookup"><span data-stu-id="76623-p110">When you create a new customer using the [Partner Center API](https://partnercenter.microsoft.com/ru-RU/partner/developer), a new customer tenant gets created. Additionally, a partner relationship also gets created, which makes you the partner of record for this new customer tenant. This partner relationship can take up to 3 minutes to propagate to the new customer tenant. If your app calls Microsoft Graph straight after creation, your app will likely receive an access denied error. A similar delay may be experienced when an existing customer accepts your invitation. This is because pre-consent relies on the partner relationship being present in the customer tenant.</span></span>

<span data-ttu-id="76623-p111">Во избежание этой проблемы рекомендуем сделать так, чтобы приложение партнера вызывало Azure AD для получения токена (требуется при вызове Microsoft Graph) только через **три минуты** после создания пользователя. В большинстве случаев этого будет достаточно. Но если через три минуты снова появится ошибка авторизации, подождите еще 60 секунд и попробуйте еще раз.</span><span class="sxs-lookup"><span data-stu-id="76623-p111">To avoid this problem, we recommend that your partner app should should wait **three minutes** after customer creation before calling Azure AD to acquire a token (to call Microsoft Graph). This should cover most cases. However, if after waiting three minutes you still recieve an authorization error, please wait an additional 60 seconds and try again.</span></span>

> <span data-ttu-id="76623-p112">**ПРИМЕЧАНИЕ.** При повторной попытке нужно получить новый маркер доступа из Azure AD перед вызовом Microsoft Graph.  Вызов Microsoft Graph с помощью имеющегося маркера доступа не сработает, так как этот токен действует в течение часа и не будет содержать утверждений о предварительно предоставленном разрешении.</span><span class="sxs-lookup"><span data-stu-id="76623-p112">**NOTE:** On the retry, you must acquire a new access token from Azure AD, before calling Microsoft Graph.  Calling Microsoft Graph with the access token you already have will not work, because the access token is good for an -0=hour and won’t contain the pre-consented permission claims.</span></span>
