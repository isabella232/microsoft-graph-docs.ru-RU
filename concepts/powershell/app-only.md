---
title: Использование проверки подлинности только для приложений с помощью SDK Microsoft Graph PowerShell
description: Узнайте, как использовать проверку подлинности только для приложений, чтобы включить неинтерактивные сценарии с пакетом SDK PowerShell для Microsoft Graph.
localization_priority: Normal
author: jasonjoh
ms.openlocfilehash: 6cad5979e5bd7523174a792465d015dfe7d3d217
ms.sourcegitcommit: 60ced1be6ed8dd2d23263090a1cfbc16689bb043
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/28/2020
ms.locfileid: "48782930"
---
# <a name="use-app-only-authentication-with-the-microsoft-graph-powershell-sdk"></a>Использование проверки подлинности только для приложений с помощью SDK Microsoft Graph PowerShell

Пакет SDK для PowerShell поддерживает два типа проверки подлинности: [делегированный доступ](..\auth-v2-user.md)и [доступ только для приложений](..\auth-v2-service.md). Это руководство посвящено настройке, необходимой для включения доступа только к приложениям.

> [!IMPORTANT]
> Доступ только к приложениям предоставляет разрешения непосредственно приложению и требует от администратора разрешения на требуемые области разрешений. Более подробную информацию о доступе к приложениям можно узнать в [статье платформа идентификации Майкрософт и процесс учетных данных клиента OAuth 2,0](/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow).

Давайте разберем, как настроить доступ только к приложениям для простого скрипта, чтобы вывести список пользователей и групп в клиенте Microsoft 365.

## <a name="configuration"></a>Конфигурация

Прежде чем вы сможете использовать доступ только к приложениям с помощью пакета SDK, вам потребуется следующее.

- Сертификат, который будет использоваться в качестве учетных данных для приложения. Это может быть самозаверяющий сертификат или сертификат из центра сертификации.
- Необходимо [зарегистрировать приложение](/azure/active-directory/develop/app-objects-and-service-principals) в Azure AD, настроить его с использованием областей разрешений, необходимых вашему сценарию, и предоставить общий доступ к открытому ключу для сертификата.

### <a name="certificate"></a>Сертификат

Вам потребуется сертификат X. 509, установленный в доверенном хранилище пользователя на компьютере, на котором будет выполняться сценарий. Кроме того, вам потребуется открытый ключ сертификата, экспортированный в CER-, PEM-или CRT-формате. Вам потребуется значение субъекта сертификата.

### <a name="register-the-application"></a>Регистрация приложения

Вы можете зарегистрировать приложение либо на [портале Azure Active Directory](https://aad.portal.azure.com), либо с помощью PowerShell.

# <a name="portal"></a>[Портал](#tab/azure-portal)

1. Откройте браузер и перейдите в [центр администрирования Azure Active Directory](https://aad.portal.azure.com) и войдите в систему с помощью администратора организации клиента Microsoft 365.

1. Выберите **Azure Active Directory** на панели навигации слева, затем выберите **Регистрация приложений** в разделе **Управление** .

    ![Снимок экрана с регистрациями приложений ](./images/aad-portal-app-registrations.png)

1. Выберите **Новая регистрация** . На странице **Зарегистрировать приложение** задайте необходимые значения следующим образом.

    - Введите **имя** `Graph PowerShell Script`.
    - Установите **Поддерживаемые типы учетных** записей **только для учетных записей в данном организационном каталоге** .
    - Оставьте пустым **URI перенаправления** .

    ![Снимок страницы "регистрация приложения"](./images/register-app.png)

1. Нажмите **Зарегистрировать** . На странице **сценариев PowerShell Graph** СКОПИРУЙТЕ значения **идентификатора Application (Client)** и **идентификатора каталога (клиента)** и сохраните их.

    ![Снимок экрана с ИДЕНТИФИКАТОРом приложения для новой регистрации приложения](./images/aad-application-id.png)

1. Выберите **разрешения API** в разделе **Управление** . Нажмите кнопку **Добавить разрешение** .

1. Выберите **Microsoft Graph** , а затем — **разрешения приложений** . Добавьте **User. Read. ALL** и **Group. Read. ALL** , а затем выберите **Добавить разрешения** .

1. В **настроенных разрешениях** удалите делегированного **пользователя.** разрешение на чтение **в Microsoft Graph** , выбрав элемент **...** справа от разрешения и выбрав пункт **удалить разрешение** . Нажмите кнопку **Да, удалить** для подтверждения.

1. Нажмите кнопку **предоставить согласие администратора для...** , а затем выберите **Да** , чтобы предоставить согласие администратора для настроенных разрешений приложения. В столбце **состояние** в **настроенной таблице разрешений** изменяется значение **предоставлено для...** .

    ![Снимок экрана с настроенными разрешениями для веб-перехватчика с предоставлением разрешения администратора](./images/configured-permissions.png)

1. Выберите **Сертификаты и секреты** в разделе **Управление** . Нажмите кнопку **отправить сертификат** . Перейдите к файлу открытого ключа сертификата и нажмите кнопку **Добавить** .

# <a name="powershell"></a>[PowerShell](#tab/powershell)

> [!NOTE]
> Необходимо [установить](installation.md) пакет SDK для Microsoft Graph PowerShell, прежде чем выполнять указанные ниже действия.

Вы можете заинтересовать: "я могу использовать пакет SDK PowerShell для регистрации приложения, чтобы можно было использовать пакет SDK PowerShell?" Нет! В этом случае используется пакет SDK PowerShell с делегированным доступом, вход в систему в качестве администратора и создание регистрации приложения. Затем с помощью регистрации этого приложения вы можете использовать пакет SDK для PowerShell с доступом только для приложений, что позволит использовать сценарии для автоматической установки.

1. С помощью текстового редактора создайте новый файл с именем **RegisterAppOnly.ps1** . Вставьте в файл следующий код.

    :::code language="powershell" source="RegisterAppOnly.ps1":::

1. Сохраните файл. Откройте PowerShell в каталоге, содержащем **RegisterAppOnly.ps1** и выполните следующую команду.

    ```powershell
    .\RegisterAppOnly.ps1 -AppName "Graph PowerShell Script" -CertPath "PATH_TO_PUBLIC_KEY_FILE"
    ```

1. Откройте браузер по своему запросу. Войдите в систему с учетной записью администратора и примите соответствующие разрешения.

1. Просмотрите выходные данные приглашения `Please go to the following URL in your browser to provide admin consent` . Скопируйте предоставленный URL-адрес и вставьте его в браузере. Войдите в систему, используя учетную запись администратора, чтобы предоставить согласие администратора для нового зарегистрированного приложения.

    > [!NOTE]
    > После предоставления согласия администратора браузер отобразит сообщение об ошибке: `AADSTS500113: No reply address is registered for the application` . Это связано с тем, что регистрация приложения не включает URL-адрес перенаправления. Эту ошибку можно игнорировать.

1. Просмотрите остальные выходные данные PowerShell для команды, `Connect-MgGraph` заполненные значениями для регистрации приложения.

---

## <a name="authenticate"></a>Проверка подлинности

После выполнения описанных выше действий по настройке необходимо выполнить три части информации.

- Тема сертификата, отправленного в регистрацию приложения Azure AD.
- Идентификатор приложения для регистрации приложения.
- Идентификатор клиента.

Используйте их для проверки подлинности. Откройте PowerShell и выполните следующую команду, заменив заполнители сведениями.

```powershell
Connect-MgGraph -ClientID YOUR_APP_ID -TenantId YOUR_TENANT_ID -CertificateName YOUR_CERT_SUBJECT
```

В случае успеха вы увидите, что `Welcome To Microsoft Graph!` . Запустите, `Get-MgContext` чтобы убедиться, что вы прошли проверку подлинности только для приложений. Выходные данные должны выглядеть так, как показано ниже.

```powershell
ClientId              : YOUR_APP_ID
TenantId              : YOUR_TENANT_ID
CertificateThumbprint :
Scopes                : {Group.Read.All, User.Read.All}
AuthType              : AppOnly
CertificateName       : YOUR_CERT_SUBJECT
Account               :
AppName               : Graph PowerShell Script
ContextScope          : Process
```

## <a name="create-the-script"></a>Создание скрипта

Создайте новый файл с именем **GraphAppOnly.ps1** и добавьте следующий код.

```powershell
# Authenticate
Connect-MgGraph -ClientID YOUR_APP_ID -TenantId YOUR_TENANT_ID -CertificateName YOUR_CERT_SUBJECT

Write-Host "USERS:"
Write-Host "======================================================"
# List first 50 users
Get-MgUser -Property "id,displayName" -PageSize 50 | Format-Table DisplayName, Id

Write-Host "GROUPS:"
Write-Host "======================================================"
# List first 50 groups
Get-MgGroup -Property "id,displayName" -PageSize 50 | Format-Table DisplayName, Id

# Disconnect
Disconnect-MgGraph
```

Замените заполнители в `Connect-MgGraph` команде информацией. Сохраните файл, а затем откройте PowerShell в каталоге, в котором вы создали файл. Выполните сценарий с помощью приведенной ниже команды.

```powershell
.\GraphAppOnly.ps1
```

Сценарий выводит список пользователей и групп, похожий на приведенные ниже выходные данные (сокращенный для краткости).

```powershell
Welcome To Microsoft Graph!
USERS:
======================================================

DisplayName              Id
-----------              --
Conf Room Adams          88d1ba68-8ff5-4de2-90ed-768c00abcfae
Adele Vance              3103c7b9-cfe6-4cd3-a696-f88909b9a609
MOD Administrator        da3a885e-2d97-41de-9347-5271ef321b58
...

GROUPS:
======================================================

DisplayName                         Id
-----------                         --
App Development                     06dce3e5-d310-4add-ab2c-be728fb9076e
All Employees                       1a1cd42d-9801-4e9d-9b77-5215886174ef
Mark 8 Project Team                 2bf1b0d0-81f6-4e80-b971-d1db69f8d651
...
```
