# <a name="get-started-with-microsoft-graph-in-a-python-app"></a><span data-ttu-id="c8f6f-101">Начало работы с Microsoft Graph в приложении Python</span><span class="sxs-lookup"><span data-stu-id="c8f6f-101">Get started with Microsoft Graph in a Python app</span></span> 

<span data-ttu-id="c8f6f-102">В этой статье описано, как получить маркер доступа из Azure AD и вызвать Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-102">This article describes the tasks required to get an access token from Azure AD and call Microsoft Graph.</span></span> <span data-ttu-id="c8f6f-103">Из нее вы узнаете, как [отправить почту через Microsoft Graph из приложения Python](https://github.com/microsoftgraph/python-sample-send-mail), и что необходимо для использования API Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-103">It walks you through [Sending mail via Microsoft Graph from Python](https://github.com/microsoftgraph/python-sample-send-mail) and explains the main concepts that you implement to use the Microsoft Graph API.</span></span> <span data-ttu-id="c8f6f-104">В этой статье описано, как получить доступ к Microsoft Graph, используя прямые вызовы REST.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-104">The article describes how to access Microsoft Graph by using direct REST calls.</span></span>

![Форма отправки почты](https://raw.githubusercontent.com/microsoftgraph/python-sample-send-mail/master/static/images/sendmail.png)

## <a name="choosing-an-authentication-library"></a><span data-ttu-id="c8f6f-106">Выбор библиотеки аутентификации</span><span class="sxs-lookup"><span data-stu-id="c8f6f-106">Choosing an authentication library</span></span>

<span data-ttu-id="c8f6f-107">Для вызова Microsoft Graph приложение должно получить действительный маркер доступа из Azure Active Directory (Azure AD) — облачной службы идентификации Майкрософт. Маркер необходимо передавать в заголовке HTTP каждого вызова REST API Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-107">To make calls to Microsoft Graph, your app must obtain a valid access token from Azure Active Directory (Azure AD), the Microsoft cloud identity service, and the token must be passed in an HTTP header with each call to the Microsoft Graph REST API.</span></span> <span data-ttu-id="c8f6f-108">Подход к аутентификацию, реализованный в Graph, основан на стандартах OAuth 2.0 и Open ID Connect, поэтому доступен широкий выбор [библиотек аутентификации](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-v2-libraries).</span><span class="sxs-lookup"><span data-stu-id="c8f6f-108">Graph's approach to authentication is based on the OAuth 2.0 and Open ID Connect standards, so there are many [authentication libraries](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/active-directory-v2-libraries) that you can choose from to implement authentication in your application.</span></span>

<span data-ttu-id="c8f6f-109">В приведенном ниже примере используется библиотека [Flask-OAuthlib](https://flask-oauthlib.readthedocs.io/en/latest/) для реализации рабочего процесса OAuth 2.0 с [предоставлением кода авторизации](https://tools.ietf.org/html/rfc6749#section-4.1), который рекомендуется использовать для веб-приложений, написанных на Python.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-109">The sample covered below uses the [Flask-OAuthlib](https://flask-oauthlib.readthedocs.io/en/latest/) library to implement OAuth 2.0 [Authorization Code Grant](https://tools.ietf.org/html/rfc6749#section-4.1) workflow, which is the recommended auth workflow for web applications written in Python.</span></span> <span data-ttu-id="c8f6f-110">Информацию о других способах аутентификации см. в [примерах аутентификации на Python для Microsoft Graph](https://github.com/microsoftgraph/python-sample-auth).</span><span class="sxs-lookup"><span data-stu-id="c8f6f-110">For information about other authentication options, see [Python authentication samples for Microsoft Graph](https://github.com/microsoftgraph/python-sample-auth).</span></span>

## <a name="installing-and-running-the-send-mail-sample"></a><span data-ttu-id="c8f6f-111">Установка и запуск примера приложения для отправки почты</span><span class="sxs-lookup"><span data-stu-id="c8f6f-111">Installing and running the send-mail sample</span></span>

<span data-ttu-id="c8f6f-112">Чтобы установить и настроить пример приложения, выполните действия, описанные в статье [Установка примеров Python REST](https://github.com/microsoftgraph/python-sample-auth/blob/master/installation.md).</span><span class="sxs-lookup"><span data-stu-id="c8f6f-112">To install and configure the sample app, follow the instructions in [Installing the Python REST samples](https://github.com/microsoftgraph/python-sample-auth/blob/master/installation.md).</span></span> <span data-ttu-id="c8f6f-113">Чтобы использовать рассматриваемый ниже пример, клонируйте репозиторий с помощью следующей команды:</span><span class="sxs-lookup"><span data-stu-id="c8f6f-113">For the send-mail sample covered below, use this command to clone the repo:</span></span>

```git clone https://github.com/microsoftgraph/python-sample-send-mail.git```

<span data-ttu-id="c8f6f-114">Регистрируя приложение, как описано в [инструкциях по установке](https://github.com/microsoftgraph/python-sample-auth/blob/master/installation.md), обязательно включите разрешения **User.Read** и **Mail.Send**, которые необходимы для этого примера.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-114">When you register the application as covered in the [installation instructions](https://github.com/microsoftgraph/python-sample-auth/blob/master/installation.md), be sure to include the **User.Read** and **Mail.Send** permissions, which are required for this sample.</span></span>

<span data-ttu-id="c8f6f-115">После установки и настройки вы можете запустить пример приложения, следуя [этим инструкциям](https://github.com/microsoftgraph/python-sample-send-mail#running-the-sample).</span><span class="sxs-lookup"><span data-stu-id="c8f6f-115">After completing the installation/configuration, you can run the sample app by following the instructions for [running the sample](https://github.com/microsoftgraph/python-sample-send-mail#running-the-sample).</span></span>

## <a name="code-walkthrough"></a><span data-ttu-id="c8f6f-116">Разбор кода</span><span class="sxs-lookup"><span data-stu-id="c8f6f-116">Code walkthrough</span></span>

<span data-ttu-id="c8f6f-117">Ниже приведен обзор [исходного кода](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py) примера приложения.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-117">The following is an overview of the [source code](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py) for the sample app.</span></span>

<span data-ttu-id="c8f6f-118">Первые несколько строк кода предназначены для [импорта](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L4-L32) модулей и пакетов Python, используемых в примере:</span><span class="sxs-lookup"><span data-stu-id="c8f6f-118">The first few lines of code are the [imports](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L4-L32) for the Python modules and packages used in the sample:</span></span>

* <span data-ttu-id="c8f6f-119">Модуль **base64** из стандартной библиотеки используется для кодирования вложений электронной почты.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-119">The **base64** module from the standard library is used for encoding email attachments.</span></span>
* <span data-ttu-id="c8f6f-120">Модуль **mimetypes** позволяет определить тип MIME для вложенных файлов.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-120">The **mimetypes** module is used to determine the MIME type for file attachments.</span></span>
* <span data-ttu-id="c8f6f-121">Модуль **os** обеспечивает общую функциональность файловой системы.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-121">The **os** module provides common file system functionality.</span></span>
* <span data-ttu-id="c8f6f-122">Модуль **pprint** из стандартной библиотеки используется для структурированного вывода сообщений об ошибках, которые возвращает Graph,</span><span class="sxs-lookup"><span data-stu-id="c8f6f-122">The **pprint** module from the standard library is used to pretty-print any error messages returned by Graph.</span></span> <span data-ttu-id="c8f6f-123">например при попытке отправить сообщение на недействительный электронный адрес.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-123">(For example, if you try to send to an invalid email address.)</span></span>
* <span data-ttu-id="c8f6f-124">Модуль **uuid** из стандартной библиотеки используется для создания случайной строки длиной 36 символов, однозначно определяющей каждый запрос Graph.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-124">The **uuid** module from the standard library is used to generate a random 36-character string to uniquely identify each Graph request.</span></span> <span data-ttu-id="c8f6f-125">Это может быть полезно для отладки.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-125">This can be useful for debugging purposes.</span></span>
* <span data-ttu-id="c8f6f-126">Пакет **flask** — это веб-платформа для примера.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-126">The **flask** package is the web framework for the sample.</span></span>
* <span data-ttu-id="c8f6f-127">Класс **OAuth** в файле **flask_oauthlib.client** — это оболочка для приложения Flask, в котором реализуется рабочий процесс аутентификации OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-127">The **OAuth** class of **flask_oauthlib.client** is a wrapper around the Flask app that implements the OAuth 2.0 authentication workflow.</span></span>
* <span data-ttu-id="c8f6f-128">Модуль **config** содержит параметры регистрации приложения, настроенные в описанном выше процессе установки.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-128">The **config** module contains the application registration settings, as configured in the installation process above.</span></span>

<span data-ttu-id="c8f6f-129">После этого мы [создаем приложение Flask](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L15-L17) и [клиентский объект Graph](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L19-L28) под названием **MSGRAPH**.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-129">Next, we [create a Flask app](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L15-L17) and then create the [Graph client object](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L19-L28), named **MSGRAPH**.</span></span>

<span data-ttu-id="c8f6f-130">За этими начальными этапами настройки следуют три функции обработчика маршрута Flask, реализующие рабочий процесс аутентификации: [homepage()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L30-L33), [login()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L35-L39) и [authorized()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L41-L48).</span><span class="sxs-lookup"><span data-stu-id="c8f6f-130">After those initial setup steps come three Flask route handler functions that implement the authentication workflow: [homepage()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L30-L33), [login()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L35-L39), and [authorized()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L41-L48).</span></span> <span data-ttu-id="c8f6f-131">Дополнительные сведения о рабочем процессе аутентификации см. в разделе [Пример архитектуры](https://github.com/microsoftgraph/python-sample-auth#sample-architecture) репозитория примеров аутентификации на Python.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-131">For more information about the authentication workflow, see the [Sample architecture](https://github.com/microsoftgraph/python-sample-auth#sample-architecture) section of the Python authentication samples repo.</span></span>

<span data-ttu-id="c8f6f-132">Следующий обработчик маршрута, [mailform()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L50-L83), — это форма для указания получателей, темы и текста сообщения.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-132">The next route handler, [mailform()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L50-L83), is the form where you specify email recipients, subject, and body.</span></span> <span data-ttu-id="c8f6f-133">Обратите внимание на то, что эта функция также включает наши первые вызовы Graph (в том числе получает профиль пользователя и фотографию профиля, отправляет ее в OneDrive и создает ссылку для доступа).</span><span class="sxs-lookup"><span data-stu-id="c8f6f-133">Note that this function also includes our first calls to Graph, including retrieving the user profile and profile photo, uploading the photo to OneDrive, and creating a sharing link.</span></span> <span data-ttu-id="c8f6f-134">Данные [передаются в шаблон mailform.html](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L77-L83), в котором получателя, тему и текст сообщения можно изменить перед отправкой.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-134">The data is [passed to the mailform.html template](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L77-L83), where the recipient, subject and body can be edited before sending the message.</span></span> 

<span data-ttu-id="c8f6f-135">За ним следует функция [send_mail()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L85-L107), которая отправляет сообщение и показывает ответ API Graph.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-135">Next is the [send_mail()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L85-L107) function, which sends the email and displays the response from the Graph API.</span></span> <span data-ttu-id="c8f6f-136">Она использует вспомогательную функцию sendmail(), передавая в нее параметры строки запроса, опубликованные из формы:</span><span class="sxs-lookup"><span data-stu-id="c8f6f-136">It uses a sendmail() helper function, passing to it the query string parameters that were posted from the form:</span></span>

```python
response = sendmail(client=MSGRAPH,
                    subject=flask.request.args['subject'],
                    recipients=flask.request.args['email'].split(';'),
                    body=flask.request.args['body'],
                    attachments=[profile_pic])
```

<span data-ttu-id="c8f6f-137">Функция [get_token()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L109-L123) используется экземпляром клиента Flask-OAuthlib (```MSGRAPH```) для получения маркера доступа при каждом вызове Graph.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-137">The [get_token()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L109-L123) function is used by the Flask-OAuthlib client instance (```MSGRAPH```) to obtain an access token whenever we make calls to Graph.</span></span> <span data-ttu-id="c8f6f-138">Маркер доступа передается в заголовке HTTP **Authorization**, но в данном случае нам не нужно его использовать.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-138">The access token is passed in an HTTP header named **Authorization**, but you don't need to deal with this in your code.</span></span> <span data-ttu-id="c8f6f-139">Вы можете просто вызывать Graph с помощью методов HTTP клиента, например get() или post(), а экземпляр клиента будет вызывать ```get_token()``` для получения маркера, так как функция [содержит](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L109-L109) ```tokengetter```.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-139">You can simply make calls to Graph via the client's HTTP verb methods (for example, get() or post()), and the client instance will know to call ```get_token()``` to obtain a token, because the function is [decorated](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L109-L109) with ```tokengetter```.</span></span>

<span data-ttu-id="c8f6f-140">Остальная часть примера состоит из вспомогательных функций, упрощающих основные действия Graph:</span><span class="sxs-lookup"><span data-stu-id="c8f6f-140">The remainder of the sample is helper functions that simplify common Graph activities:</span></span>

* <span data-ttu-id="c8f6f-141">[request_headers()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L114-L123) возвращает словарь HTTP-заголовков, отправляемых с каждым вызовом Graph.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-141">[request_headers()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L114-L123) returns a dictionary of HTTP headers to be sent with each call to Graph.</span></span>
* <span data-ttu-id="c8f6f-142">[profile_photo()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L125-L154) возвращает фотографию профиля пользователя и при необходимости сохраняет копию в локальном файле.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-142">[profile_photo()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L125-L154) returns the user's profile photo and optionally saves a copy to a local file.</span></span>
* <span data-ttu-id="c8f6f-143">[sendmail()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L156-L202) отправляет сообщение, используя конечную точку ```me/microsoft.graph.sendMail```.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-143">[sendmail()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L156-L202) sends a message using the ```me/microsoft.graph.sendMail``` endpoint.</span></span>
* <span data-ttu-id="c8f6f-144">[sharing_link()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L204-L221) создает ссылку для доступа к указанному элементу OneDrive.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-144">[sharing_link()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L204-L221) creates a sharing link for a specified item in OneDrive.</span></span>
* <span data-ttu-id="c8f6f-145">[upload_file()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L223-L255) отправляет файл в OneDrive.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-145">[upload_file()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L223-L255) uploads a file to OneDrive.</span></span>

<span data-ttu-id="c8f6f-146">Эти вспомогательные функции могут пригодиться вам в других приложениях.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-146">You may find these helper functions useful in other applications.</span></span>

## <a name="other-python-rest-samples"></a><span data-ttu-id="c8f6f-147">Другие примеры кода на Python REST</span><span class="sxs-lookup"><span data-stu-id="c8f6f-147">Other Python REST samples</span></span>

<span data-ttu-id="c8f6f-148">Вот некоторые примеры кода на Python, демонстрирующие работу с различными аспектами Microsoft Graph:</span><span class="sxs-lookup"><span data-stu-id="c8f6f-148">Here are some other Python samples that demonstrate how to work with various aspects of Microsoft Graph:</span></span>

* [<span data-ttu-id="c8f6f-149">Примеры кода аутентификации на Python для Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="c8f6f-149">Python authentication samples for Microsoft Graph</span></span>](https://github.com/microsoftgraph/python-sample-auth)
* [<span data-ttu-id="c8f6f-150">Работа с разбитыми на страницы ответами Microsoft Graph в Python</span><span class="sxs-lookup"><span data-stu-id="c8f6f-150">Working with paginated Microsoft Graph responses in Python</span></span>](https://github.com/microsoftgraph/python-sample-pagination)
* [<span data-ttu-id="c8f6f-151">Работа с открытыми расширениями Graph в Python</span><span class="sxs-lookup"><span data-stu-id="c8f6f-151">Working with Graph open extensions in Python</span></span>](https://github.com/microsoftgraph/python-sample-open-extensions)
* [<span data-ttu-id="c8f6f-152">Подключение веб-приложения Python к API безопасности</span><span class="sxs-lookup"><span data-stu-id="c8f6f-152">Connect a Python web app to the Security API</span></span>](https://github.com/microsoftgraph/python-security-rest-sample)

<span data-ttu-id="c8f6f-153">Если вы бы хотели увидеть конкретный пример, [отправьте нам заявку](https://github.com/microsoftgraph/python-sample-auth/issues).</span><span class="sxs-lookup"><span data-stu-id="c8f6f-153">If there's a particular sample you'd like to see, please let us know by [submitting an issue](https://github.com/microsoftgraph/python-sample-auth/issues).</span></span> <span data-ttu-id="c8f6f-154">Мы будем рады узнать, какие сценарии Microsoft Graph вы хотели бы реализовать на Python!</span><span class="sxs-lookup"><span data-stu-id="c8f6f-154">We're very interested in your feedback on any Microsoft Graph scenario you'd like to build in Python!</span></span>

<span data-ttu-id="c8f6f-155">API Microsoft Graph — единый мощный API, с помощью которого можно взаимодействовать со всеми типами данных Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="c8f6f-155">The Microsoft Graph API is a very powerful, unifiying API that can be used to interact with all kinds of Microsoft data.</span></span> <span data-ttu-id="c8f6f-156">Чтобы узнать больше о возможностях Microsoft Graph, ознакомьтесь с [документацией для разработчиков](https://developer.microsoft.com/ru-RU/graph/docs/concepts/overview) или опробуйте [песочницу Graph](https://developer.microsoft.com/ru-RU/graph/graph-explorer).</span><span class="sxs-lookup"><span data-stu-id="c8f6f-156">Check out the [developer documentation](https://developer.microsoft.com/ru-RU/graph/docs/concepts/overview) or the [Graph Explorer](https://developer.microsoft.com/ru-RU/graph/graph-explorer) to explore what else you can accomplish with Microsoft Graph.</span></span>
