# <a name="call-microsoft-graph-from-a-cloud-solution-provider-application"></a>Вызов Microsoft Graph из приложения CSP

> **Примечание.** Эта статья предназначена **только** для разработчиков приложений CSP. Программа [Поставщик облачных решений (Майкрософт) (CSP)](https://partner.microsoft.com/en-US/cloud-solution-provider) позволяет партнерам Майкрософт перепродавать веб-службы Майкрософт клиентам и управлять ими.

В этом разделе описано, как предоставить приложению доступ к данным клиентов, управляемым партнером, через Microsoft Graph, используя [поток предоставления кодов авторизации](https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-protocols-oauth-code) или [поток клиентских учетных данных между службами](https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-protocols-oauth-service-to-service).

**Важно!** Вызов Microsoft Graph из приложения CSP поддерживается только для ресурсов каталога (таких как **user**, **group**, **device**, **organization**) и ресурсов [Intune](../api-reference/beta/resources/intune_graph_overview.md).

## <a name="what-is-a-partner-managed-application"></a>Что такое приложение, управляемое партнером

Программа CSP позволяет партнерам Майкрософт перепродавать веб-службы Майкрософт (такие как Office 365, Microsoft Azure и CRM Online) клиентам и управлять ими. Управление службами клиента осуществляется с помощью делегированных полномочий администратора, которые позволяют агентам партнера настраивать среды клиентов.

Кроме того, партнер-разработчик может создать **приложение, управляемое партнером**, для управления службами Майкрософт клиента. Приложения, управляемые партнером, часто называются приложениями *с предварительным доступом*, так как этим приложениям автоматически предоставляется доступ к данным всех клиентов. При работе с ними пользователю из одного из доменов клиента не нужно давать согласие на доступ к данным. Приложения, управляемые партнерами, также наследуют делегированные права администратора, поэтому агенты партнера также могут получить привилегированный доступ к клиентам через такое приложение.

## <a name="how-to-set-up-a-partner-managed-application"></a>Как настроить приложение, управляемое партнером

Считается, что приложение *управляется партнером*, если ему предоставлены расширенные права на доступ к данным клиента.

> **Примечание.** Приложения, управляемые партнером, можно настроить *только* на уровне доменов Партнера. Для управления ресурсами домена клиента приложения, управляемые партнером, **необходимо** настроить как **мультитенантные**.

### <a name="register-and-configure-a-multi-tenant-app"></a>Регистрация и настройка мультитенантного приложения

Сначала вам нужно выполнить действия по регистрации и настройке мультитенантного приложения:

1. [Зарегистрируйте приложение](https://docs.microsoft.com/en-us/azure/active-directory/active-directory-app-registration) в домене Партнера на [портале Azure](https://portal.azure.com). Настройте приложение как [мультитенантное](https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-devhowto-multi-tenant-overview#update-registration-to-be-multi-tenant), чтобы партнер мог им управлять. Если приложение развернуто и продается в нескольких географических регионах, его нужно зарегистрировать в каждом из них, как описано <a href="#region">здесь</a>.
2. На портале Azure предоставьте мультитенантному приложению *необходимые разрешения*, используя принцип минимальных привилегий.

### <a name="pre-consent-your-app-for-all-your-customers"></a>Предоставление приложению доступа к данным всех клиентов

Предоставьте приложению, управляемому партнером, настроенные разрешения для доступа к данным всех ваших клиентов. Для этого добавьте атрибут **servicePrincipal**, представляющий приложение, в группу *Adminagents* в домене Партнера, используя PowerShell Azure AD версии 2. Скачать и установить PowerShell Azure AD версии 2 можно [здесь](https://www.powershellgallery.com/packages/AzureAD).  Выполните указанные ниже шаги, чтобы найти группу *Adminagents*, и добавьте в нее атрибут **servicePrincipal**.

1. Откройте сеанс PowerShell и подключитесь к домену партнера, введя учетные данные администратора в окне входа.

    ```PowerShell
    Connect-AzureAd
    ```

2. Найдите группу *Adminagents*.

    ```PowerShell
    $group = Get-AzureADGroup -Filter "displayName eq 'Adminagents'"
    ```

3. Найдите субъект-службу с тем же, *appId*, что и у приложения.

    ```PowerShell
    $sp = Get-AzureADServicePrincipal -Filter "appId eq '{yourAppsAppId}'"
    ```

4. Добавьте субъект-службу в группу *Adminagents*.

    ```PowerShell
    Add-AzureADGroupMember -ObjectId $group.ObjectId -RefObjectId $sp.ObjectId
    ```

## <a name="token-acquisition-flows"></a>Потоки получения маркеров

Потоки получения маркеров для приложений, управляемых партнерами, — [поток предоставления кодов авторизации](https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-protocols-oauth-code) и [поток учетных данных клиентов между службами](https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-protocols-oauth-service-to-service) — такие же, как и для обычных мультитенантных приложений.

Помимо предварительного доступа ко всем доменам клиента, приложения, управляемые партнерами, имеют одну дополнительную возможность. С помощью таких приложений агенты могут получать доступ к данным доменов клиентов (используя делегированные права администратора). Принцип работы изложен ниже.

1. Агент входит в приложение с помощью учетных данных пользователя, полученных из домена партнера.
2. Приложение запрашивает маркер доступа для нужного домена клиента, управляемого партнером.
3. Приложение использует маркер доступа для вызова Microsoft Graph.

Это стандартный [поток предоставления кодов авторизации](https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-protocols-oauth-code), но агенты должны входить в свои учетные записи партнеров. Рассмотрим, как это выглядит на практике. Допустим, домен партнера — *partner.com* (домашний домен агентов), а домен клиента — *customer.com*:

1. [Получите код авторизации.](https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-protocols-oauth-code#request-an-authorization-code) Приложение отправляет запрос в конечную точку ```/authorize``` и должно использовать **домен клиента** (в нашем примере — ```customer.com```) в качестве целевого. Ваши агенты по-прежнему смогут входить в учетную запись ```username@partner.com```.

    ```http
    GET https://login.microsoftonline.com/customer.com/oauth2/authorize
    ```

2. [Получите маркер доступа, используя код авторизации.](https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-protocols-oauth-code#use-the-authorization-code-to-request-an-access-token) Отправляя запрос в конечную точку ```token```, приложение должно использовать **домен клиента** в качестве целевого домена, в нашем примере это ```customer.com```:

    ```http
    POST https://login.microsoftonline.com/customer.com/oauth2/token
    ```

3. Теперь, когда у вас есть маркер доступа, вызовите Microsoft Graph, поместив маркер доступа в заголовок авторизации HTTP:

    ```http
    GET https://graph.microsoft.com/beta/users
    Authorization: Bearer <token>
    ```

## <a name="register-your-app-in-the-regions-you-support"></a>Регистрация приложения в поддерживаемых регионах
<a name="region"></a>

В настоящее время взаимодействие с клиентами в рамках программы CSP ограничено одним регионом. В отношении управляемых партнерами приложений действует такое же ограничение. Это означает, что для каждого региона, где вы осуществляете продажи, нужен отдельный домен. Например, если ваше приложение, управляемое партнером, зарегистрировано в домене в США, а ваш клиент находится в ЕС, такое приложение работать не будет.  Каждый региональный домен партнера должен содержать собственный набор приложений, управляемых партнерами, для управления клиентами в том же регионе. При этом в приложение необходимо включить дополнительную логику, которая будет решать (до входа), какой региональный идентификатор приложения, управляемого партнером, показывать пользователю на основе имени для входа.

## <a name="calling-microsoft-graph-immediately-after-customer-creation"></a>Вызов Microsoft Graph сразу же после создания клиента

При создании нового клиента с помощью [API Центра партнеров](https://partnercenter.microsoft.com/en-us/partner/developer) создается новый домен. Кроме того, создается отношение партнеров — вы становитесь партнером для этого нового домена клиента. Передача этого отношения в новый домен клиента может занять до 3 минут. Если приложение вызовет Microsoft Graph сразу после создания, ему, скорее всего, будет отказано в доступе. Аналогичная задержка может возникать после принятии вашего приглашения существующим клиентом. Это связано с тем, что предварительное предоставление доступа зависит от наличия отношения партнеров в домене клиента.

Во избежание этой проблемы рекомендуется, чтобы приложение партнера вызывало Azure AD для получения маркера (для вызова Microsoft Graph) через **три минуты** после создания клиента. В большинстве случаев этого будет достаточно. Но если через три минуты снова появится ошибка авторизации, подождите еще 60 секунд и попробуйте еще раз.

> **Примечание.** Перед повторным вызовом Microsoft Graph нужно получить новый маркер доступа из Azure AD.  Вызвать Microsoft Graph с помощью имеющегося маркера доступа не получится, так как маркер доступа действует в течение часа и не будет содержать утверждений о предоставленном доступе.
