---
title: Отслеживание изменений в данных Microsoft Graph с помощью разностного запроса
description: Запросы изменений позволяют приложениям обнаруживать новые, обновленные и удаленные сущности, не считывая целевой ресурс полностью при каждом запросе. Приложения Microsoft Graph могут использовать запросы изменений, чтобы эффективно синхронизировать изменения с локальным хранилищем данных.
ms.openlocfilehash: 4732cabed3595738b70c54a7a029f19400edbe6f
ms.sourcegitcommit: 334e84b4aed63162bcc31831cffd6d363dafee02
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/29/2018
ms.locfileid: "27092735"
---
# <a name="use-delta-query-to-track-changes-in-microsoft-graph-data"></a>Отслеживание изменений в данных Microsoft Graph с помощью разностного запроса

Запросы изменений позволяют приложениям обнаруживать новые, обновленные и удаленные сущности, не считывая целевой ресурс полностью при каждом запросе. Приложения Microsoft Graph могут использовать запросы изменений, чтобы эффективно синхронизировать изменения с локальным хранилищем данных.

## <a name="use-delta-query-to-track-changes-in-a-resource-collection"></a>Отслеживание изменений в коллекции ресурсов с помощью запроса изменений

Ниже представлен типичный шаблон вызова.

1. Для начала приложение выполняет запрос GET с функцией delta для нужного ресурса.
2. Microsoft Graph отправит ответ, содержащий нужный ресурс и [маркер состояния](#state-tokens).

     -  Если возвращается URL-адрес `nextLink`, это означает, что во время сеанса могли быть получены не все страницы данных. Для получения всех страниц данных приложение продолжает отправлять запросы, используя URL-адрес `nextLink`, пока в отклик не будет включен URL-адрес `deltaLink`.

     - Если возвращается URL-адрес `deltaLink`, это означает, что больше нет данных о текущем состоянии ресурса. В последующих запросах приложение использует URL-адрес `deltaLink`, чтобы узнавать об изменениях ресурса.

3. Когда приложению требуется узнать об изменениях ресурса, оно совершает новый запрос, используя URL-адрес `deltaLink`, полученный на шаге 2. Этот запрос *может* быть совершен сразу по завершении шага 2 или когда приложение проверяет наличие изменений.
4. Microsoft Graph возвращает описание изменений ресурса с момента последнего запроса вместе с URL-адресом `nextLink` или `deltaLink`.

>**Примечание.** Ресурсы, хранящиеся в Azure Active Directory (например, пользователи и группы), поддерживают сценарии "синхронизировать с этого момента". Это позволяет пропустить шаги 1 и 2, описанные выше (если вы не заинтересованы в получении полного состояния ресурса) и вместо этого запросить самую новую ссылку `deltaLink`. Добавьте `$deltaToken=latest` к функции `delta`, и ответ будет содержать ссылку `deltaLink`, но не будет содержать данные ресурсов.

### <a name="state-tokens"></a>Маркеры состояния

Ответ GET на запрос изменений всегда включает URL-адрес, указанный в заголовке `nextLink` или `deltaLink`. URL-адрес `nextLink` включает маркер _skipToken_, а URL-адрес `deltaLink` — _deltaToken_.

Эти маркеры непрозрачны для клиента. Вот что вам нужно знать о них:

- Каждый маркер отражает состояние и представляет моментальный снимок ресурса в этом цикле отслеживания изменений.

- Маркеры состояния также кодируют и включают другие параметры запроса (такие как `$select`), указанные в исходном запросе изменений. Таким образом, не обязательно повторять их в последующих запросах изменений.

- Совершая запрос изменений, вы можете скопировать и применить URL-адрес `nextLink` или `deltaLink` при следующем вызове функции **delta**, не проверяя содержимое URL-адреса, в том числе маркер состояния.

### <a name="optional-query-parameters"></a>Необязательные параметры запросов

Если клиент использует параметр запроса, он должен быть указан в исходном запросе. Microsoft Graph автоматически кодирует указанный параметр в ссылке `nextLink` или `deltaLink`, указанной в ответе. Вызывающему приложению достаточно один раз указать нужные параметры запроса. Microsoft Graph автоматически добавляет указанные параметры для всех последующих запросов.

Для пользователей и групп действуют ограничения на применение некоторых параметров запросов:

- Если используется параметр запроса `$select`, это означает, что клиент предпочитает отслеживать изменения только для тех свойств или связей, которые указаны в операторе `$select`. При изменении свойства, которое не было выбрано, соответствующий ресурс не появится в отклике с различиями при последующем запросе.
- `$expand` поддерживается только для навигационных свойств `manager` и `members` для пользователей и групп соответственно.

- Фильтры области позволяют отслеживать изменения одного или нескольких конкретных пользователей или групп с помощью objectId. Например, запрос https://graph.microsoft.com/beta/groups/delta/?$filter= id eq '477e9fc6-5de7-4406-bb2a-7e5c83c9ae5f' or id eq '004d6a07-fe70-4b92-add5-e6e37b8acd8e' вернет изменения для групп, идентификаторы которых соответствуют указанным в фильтре запроса.

## <a name="resource-representation-in-the-delta-query-response"></a>Представление ресурсов в отклике на разностный запрос

- Новые экземпляры поддерживаемого ресурса представлены в ответе на запрос изменений с помощью стандартных свойств.

- Обновленные экземпляры представлены **id** и *по крайней мере* обновленными свойствами, но могут быть включены и другие свойства.

- Связи между пользователями и группами представлены в виде заметок к стандартному представлению ресурса. Эти заметки представлены в формате `propertyName@delta`. Они включаются в отклик на исходный разностный запрос.

Удаленные экземпляры представлены только **id** и объектом `@removed`. Объект `@removed` может содержать дополнительные сведения о том, почему удален экземпляр. Например, "@removed": {"reason": "changed"}.

Возможные причины @removed: *changed* или *deleted*.

- *changed* указывает, что элемент удален и может быть восстановлен из [deletedItems](/graph/api/resources/directory?view=graph-rest-beta).

- *deleted* указывает, что элемент удален и не может быть восстановлен.

Объект `@removed` может возвращаться в отклике на исходный разностный запрос и в отслеживаемых откликах (deltaLink). Клиенты, использующие разностные запросы, должны иметь возможность обрабатывать эти объекты в откликах.

## <a name="supported-resources"></a>Поддерживаемые ресурсы

Разностные запросы поддерживаются для указанных ниже ресурсов.

| **Коллекция ресурсов** | **API** |
|:------ | :------ |
| Приложения (предварительная версия) | [Разностная](/graph/api/application-delta?view=graph-rest-beta) функция ресурса [приложения](/graph/api/resources/application?view=graph-rest-beta) (предварительная версия) |
| Объекты каталога | Функция [delta](/graph/api/directoryobject-delta?view=graph-rest-beta) ресурса [directoryObjects](/graph/api/resources/directoryobject?view=graph-rest-beta) (предварительная версия) |
| Перечисление ролей каталога | Функция [delta](/graph/api/directoryrole-delta?view=graph-rest-1.0) ресурса [directoryObjects](/graph/api/resources/directoryrole?view=graph-rest-1.0) |
| События в представлении (диапазоне дат) основного календаря | Функция [delta](/graph/api/event-delta?view=graph-rest-1.0) ресурса [event](/graph/api/resources/event?view=graph-rest-1.0) |
| Группы | Функция [delta](/graph/api/group-delta?view=graph-rest-1.0) ресурса [group](/graph/api/resources/group?view=graph-rest-1.0) |
| Папки почты | Функция [delta](/graph/api/mailfolder-delta?view=graph-rest-1.0) ресурса [mailFolder](/graph/api/resources/mailfolder?view=graph-rest-1.0) |
| Сообщения в папке | Функция [delta](/graph/api/message-delta?view=graph-rest-1.0) ресурса [message](/graph/api/resources/message?view=graph-rest-1.0) |
| Папки личных контактов | Функция [delta](/graph/api/contactfolder-delta?view=graph-rest-1.0) ресурса [contactFolder](/graph/api/resources/contactfolder?view=graph-rest-1.0) |
| Личные контакты в папке | Функция [delta](/graph/api/contact-delta?view=graph-rest-1.0) ресурса [contact](/graph/api/resources/contact?view=graph-rest-1.0) |
| Субъекты-службы (предварительная версия) | Функция [delta](/graph/api/serviceprincipal-delta?view=graph-rest-beta) ресурса [servicePrincipal](/graph/api/resources/serviceprincipal?view=graph-rest-beta) (предварительная версия) |
| Users | Функция [delta](/graph/api/user-delta?view=graph-rest-1.0) ресурса [user](/graph/api/resources/user?view=graph-rest-1.0) |
| Элементы на диске\* | Функция [delta](/graph/api/driveitem-delta?view=graph-rest-1.0) ресурса [driveItem](/graph/api/resources/driveitem?view=graph-rest-1.0) |
| Элементы Planner\*\* | Функция [delta](/graph/api/planneruser-list-delta?view=graph-rest-beta) всего сегмента ресурса [plannerUser](/graph/api/resources/planneruser?view=graph-rest-beta) (предварительный просмотр) |

> \* Небольшие различия в использовании ресурсов OneDrive и других поддерживаемых ресурсов касаются синтаксиса. Разностный запрос для ресурсов drive будет обновлен в соответствии с запросами для других типов ресурсов.  Дополнительные сведения о текущем синтаксисе см. в статье [Отслеживание изменений для Drive](/graph/api/item-delta?view=graph-rest-1.0).

> \*\* Шаблон использования ресурсов Planner незначительно отличается от шаблонов использования других поддерживаемых ресурсов.  Дополнительные сведения см. в [этой статье](/graph/api/planneruser-list-delta?view=graph-rest-beta).

## <a name="prerequisites"></a>Необходимые разрешения

Выполнение разностных запросов для определенного ресурса требует тех же [разрешений](./permissions-reference.md), что и его чтение.

## <a name="delta-query-request-examples"></a>Примеры разностных запросов

- [Получение добавочных изменений для событий в представлении календаря](delta-query-events.md)
- [Получение добавочных изменений сообщений в папке](./delta-query-messages.md)
- [Получение добавочных изменений групп](./delta-query-groups.md)
- [Получение добавочных изменений пользователей](./delta-query-users.md)
