#  <a name="use-delta-query-to-track-changes-in-microsoft-graph-data-preview"></a>Отслеживание изменений данных Microsoft Graph с помощью запроса изменений (предварительная версия)

Запросы изменений позволяют приложениям обнаруживать новые, обновленные и удаленные сущности, не считывая целевой ресурс полностью при каждом запросе. Приложения Microsoft Graph могут использовать запросы изменений, чтобы эффективно синхронизировать изменения с локальным хранилищем данных.

## <a name="use-delta-query-to-track-changes-in-a-resource-collection"></a>Отслеживание изменений в коллекции ресурсов с помощью запроса изменений

Ниже представлен типичный шаблон вызова.

1.  Для начала приложение совершает запрос GET с функцией delta для нужного ресурса.
2.  Microsoft Graph отправит ответ, содержащий нужный ресурс и [маркер состояния](#state-tokens).

     a.  Если возвращается URL-адрес `nextLink`, это означает, что во время сеанса получены не все страницы данных. Приложение продолжает отправлять запросы, используя URL-адрес `nextLink`, пока в ответ не будет включен URL-адрес `deltaLink`.

     b.  Если возвращается URL-адрес `deltaLink`, это означает, что больше нет данных о текущем состоянии ресурса. В последующих запросах приложение использует URL-адрес `deltaLink`, чтобы узнавать об изменениях ресурса.
     
3.  Когда приложению требуется узнать об изменениях ресурса, оно совершает новый запрос, используя URL-адрес `deltaLink`, полученный на шаге 2. Этот запрос *может* быть совершен сразу по завершении шага 2 или когда приложение проверяет наличие изменений.
4.  Microsoft Graph возвращает описание изменений ресурса с момента последнего запроса вместе с URL-адресом `nextLink` или `deltaLink`.

### <a name="state-tokens"></a>Маркеры состояния

Ответ GET на запрос изменений всегда включает URL-адрес, указанный в заголовке `nextLink` или `deltaLink`. URL-адрес `nextLink` включает маркер _skipToken_, а URL-адрес `deltaLink` — _deltaToken_. 

Эти маркеры полностью непрозрачны для клиента. Вот все, что вам нужно знать о них:

- Каждый маркер отражает состояние и представляет моментальный снимок ресурса в этом цикле отслеживания изменений. 
- Эти маркеры состояния также кодируют и включают другие параметры запроса (например, `$select`, если ресурс его поддерживает), указанные в исходном запросе изменений, чтобы вам не пришлось повторять их в последующих запросах изменений.
- Совершая запрос изменений, вы можете просто скопировать и применить URL-адрес `nextLink` или `deltaLink` без изменений при следующем вызове функции **delta**, не проверяя содержимое URL-адреса, в том числе маркер состояния.


### <a name="optional-query-parameters"></a>Необязательные параметры запросов

Если клиент использует параметр запроса, он должен быть указан в исходном запросе. Microsoft Graph автоматически закодирует указанные параметры в ссылке `nextLink` или `deltaLink`, указанной в ответе. Вызывающему приложению достаточно один раз указать нужные параметры запроса. Microsoft Graph автоматически добавляет указанные параметры для всех последующих запросов.

Для пользователей и групп действуют ограничения на использование некоторых параметров запросов:

-   Если используется параметр запроса `$select`, это означает, что клиент предпочитает отслеживать изменения только для тех свойств или отношений, которые указаны в операторе `$select`. Таким образом, при изменении свойства, которое не было выбрано, соответствующий ресурс не появится в ответе на последующий запрос.
-   Параметр `$expand` не поддерживается.

## <a name="resource-representation-in-the-delta-query-response"></a>Представление ресурсов в ответе на запрос изменений

-   Новые экземпляры поддерживаемого ресурса представлены в ответе на запрос изменений с помощью стандартных свойств.

-   Обновленные экземпляры представлены свойством **id** и *по крайней мере* обновленными свойствами, но могут быть включены и другие свойства.

-   Изменения отношений между пользователями и группами представлены в виде заметок к стандартным свойствам ресурса. Эти заметки представлены в формате `propertyName@delta` и отображаются, только если клиент явно отслеживает изменения в отношениях с помощью параметра `$select`.

-   Удаленные экземпляры представлены только свойством **id** и узлом `@removed`. Узел `@removed` может содержать дополнительные сведения о том, почему был удален экземпляр.

> **Примечание о запланированном изменении**. В настоящее время удаленные экземпляры отображаются с узлом `@removed` в следующем формате: *"@removed" : "причина удаления"*. Однако в будущем произойдут серьезные изменения. До обновления запросов изменений до версии /v1.0 в удаленные узлы будет вкладываться объект с дополнительными сведениями. Пример: *@removed {reason: "причина удаления"}*. В будущем в этот объект можно будет добавлять дополнительные метаданные об удалении.

## <a name="supported-resources"></a>Поддерживаемые ресурсы

В настоящее время предварительная версия запросов изменений поддерживается в конечной точке /beta Microsoft Graph для указанных ниже ресурсов.

| **Коллекция ресурсов** | **API** |
|:------ | :------ |
| События в представлении (диапазоне дат) основного календаря | Функция [delta](../api-reference/beta/api/event_delta.md) ресурса [event](../api-reference/beta/resources/event.md) |
| Группы | Функция [delta](../api-reference/beta/api/group_delta.md) ресурса [group](../api-reference/beta/resources/group.md) |
| Папки почты | Функция [delta](../api-reference/beta/api/mailfolder_delta.md) ресурса [mailFolder](../api-reference/beta/resources/mailFolder.md) |
| Сообщения в папке | Функция [delta](../api-reference/beta/api/message_delta.md) ресурса [message](../api-reference/beta/resources/message.md) | 
| Папки личных контактов | Функция [delta](../api-reference/beta/api/contactfolder_delta.md) ресурса [contactFolder](../api-reference/beta/resources/contactfolder.md) |
| Личные контакты в папке | Функция [delta](../api-reference/beta/api/contact_delta.md) ресурса [contact](../api-reference/beta/resources/contact.md) |
| Пользователи | Функция [delta](../api-reference/beta/api/user_delta.md) ресурса [user](../api-reference/beta/resources/user.md) | 
| Элементы на диске\* | Функция [delta](../api-reference/beta/api/item_delta.md) ресурса [driveItem](../api-reference/beta/resources/driveItem.md) |


> \* Отслеживание изменений на дисках и их дочерних объектах уже поддерживается в версии 1.0. Небольшие отличия в работе по сравнению с другими поддерживаемыми ресурсами касаются синтаксиса. Запрос изменений на дисках будет обновлен в соответствии с другими типами ресурсов. Дополнительные сведения о текущем синтаксисе см. на странице <https://developer.microsoft.com/ru-ru/graph/docs/api-reference/v1.0/api/item_delta>

## <a name="prerequisites"></a>Необходимые условия

Чтобы совершать запросы изменений в определенном ресурсе, необходимы те же [разрешения](../authorization/permission_scopes.md), что и для его чтения.

## <a name="known-limitations"></a>Известные ограничения

Отслеживание изменений в отношениях между пользователями и группами поддерживается только в рамках определенного класса ресурсов, для которого отслеживаются изменения. Например, если клиент отслеживает изменения в *группах* и выбрал отношение **members**, то он будет получать сведения об изменении участников, только если эти участники также являются *группами*. Другими словами, отслеживание членства в группах для пользователей еще не поддерживается. Разработчики Microsoft Graph понимают, что это очень важный сценарий, и планируют выпустить обновление в марте 2017 г.

## <a name="delta-query-request-examples"></a>Примеры запросов изменений 

- [Получение добавочных изменений для событий в представлении календаря (предварительная версия)](../Concepts/delta_query_events.md)
- [Получение добавочных изменений для сообщений в папке (предварительная версия)](./delta_query_messages.md)
- [Получение добавочных изменений для групп (предварительная версия)](./delta_query_groups.md)
- [Получение добавочных изменений для пользователей (предварительная версия)](./delta_query_users.md)