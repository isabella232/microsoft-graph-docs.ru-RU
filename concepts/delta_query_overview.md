#  <a name="use-delta-query-to-track-changes-in-microsoft-graph-data"></a>Отслеживание изменений в данных Microsoft Graph с помощью разностного запроса

Запросы изменений позволяют приложениям обнаруживать новые, обновленные и удаленные сущности, не считывая целевой ресурс полностью при каждом запросе. Приложения Microsoft Graph могут использовать запросы изменений, чтобы эффективно синхронизировать изменения с локальным хранилищем данных.

## <a name="use-delta-query-to-track-changes-in-a-resource-collection"></a>Отслеживание изменений в коллекции ресурсов с помощью запроса изменений

Ниже представлен типичный шаблон вызова.

1.  Для начала приложение выполняет запрос GET с функцией delta для нужного ресурса.
2.  Microsoft Graph отправит ответ, содержащий нужный ресурс и [маркер состояния](#state-tokens).

     -  Если возвращается URL-адрес `nextLink`, это означает, что во время сеанса могли быть получены не все страницы данных. Для получения всех страниц данных приложение продолжает отправлять запросы, используя URL-адрес `nextLink`, пока в отклик не будет включен URL-адрес `deltaLink`.

     - Если возвращается URL-адрес `deltaLink`, это означает, что больше нет данных о текущем состоянии ресурса. В последующих запросах приложение использует URL-адрес `deltaLink`, чтобы узнавать об изменениях ресурса.
     
3.  Когда приложению требуется узнать об изменениях ресурса, оно совершает новый запрос, используя URL-адрес `deltaLink`, полученный на шаге 2. Этот запрос *может* быть совершен сразу по завершении шага 2 или когда приложение проверяет наличие изменений.
4.  Microsoft Graph возвращает описание изменений ресурса с момента последнего запроса вместе с URL-адресом `nextLink` или `deltaLink`.

### <a name="state-tokens"></a>Маркеры состояния

Ответ GET на запрос изменений всегда включает URL-адрес, указанный в заголовке `nextLink` или `deltaLink`. URL-адрес `nextLink` включает маркер _skipToken_, а URL-адрес `deltaLink` — _deltaToken_. 

Эти маркеры непрозрачны для клиента. Вот что вам нужно знать о них:

- Каждый маркер отражает состояние и представляет моментальный снимок ресурса в этом цикле отслеживания изменений. 
- Маркеры состояния также кодируют и включают другие параметры запроса (такие как `$select`), указанные в исходном запросе изменений. Таким образом, не обязательно повторять их в последующих запросах изменений.
- Совершая запрос изменений, вы можете скопировать и применить URL-адрес `nextLink` или `deltaLink` при следующем вызове функции **delta**, не проверяя содержимое URL-адреса, в том числе маркер состояния.


### <a name="optional-query-parameters"></a>Необязательные параметры запросов

Если клиент использует параметр запроса, он должен быть указан в исходном запросе. Microsoft Graph автоматически кодирует указанный параметр в ссылке `nextLink` или `deltaLink`, указанной в ответе. Вызывающему приложению достаточно один раз указать нужные параметры запроса. Microsoft Graph автоматически добавляет указанные параметры для всех последующих запросов.

Для пользователей и групп действуют ограничения на применение некоторых параметров запросов:

-   Если используется параметр запроса `$select`, это означает, что клиент предпочитает отслеживать изменения только для тех свойств или связей, которые указаны в операторе `$select`. При изменении свойства, которое не было выбрано, соответствующий ресурс не появится в отклике с различиями при последующем запросе.
-   Параметр `$expand` не поддерживается.

Бета-версии интерфейсов API (ознакомительные версии) поддерживают фильтры, позволяя отслеживать изменения для одного или нескольких пользователей либо групп с помощью objectId. Например, запрос https://graph.microsoft.com/beta/groups/delta/?$filter= id eq '477e9fc6-5de7-4406-bb2a-7e5c83c9ae5f' or id eq '004d6a07-fe70-4b92-add5-e6e37b8acd8e' вернет изменения для групп, идентификаторы которых соответствуют указанным в фильтре запроса. 

## <a name="resource-representation-in-the-delta-query-response"></a>Представление ресурсов в отклике на разностный запрос

-   Новые экземпляры поддерживаемого ресурса представлены в ответе на запрос изменений с помощью стандартных свойств.

-   Обновленные экземпляры представлены **id** и *по крайней мере* обновленными свойствами, но могут быть включены и другие свойства.

-   Связи между пользователями и группами представлены в виде заметок к стандартному представлению ресурса. Эти заметки представлены в формате `propertyName@delta`. Они включаются в отклик на исходный разностный запрос.

Удаленные экземпляры представлены только **id** и объектом `@removed`. Объект `@removed` может содержать дополнительные сведения о том, почему удален экземпляр. Например, "@removed": {"reason": "changed"}.

Возможные причины @removed: *changed* или *deleted*.
- *changed* указывает, что элемент удален и может быть восстановлен из [deletedItems](../api-reference/beta/resources/directory.md).
- *deleted* указывает, что элемент удален и не может быть восстановлен.

Объект `@removed` может возвращаться в отклике на исходный разностный запрос и в отслеживаемых откликах (deltaLink). Клиенты, использующие разностные запросы, должны иметь возможность обрабатывать эти объекты в откликах.

## <a name="supported-resources"></a>Поддерживаемые ресурсы

Разностные запросы поддерживаются для указанных ниже ресурсов.

| **Коллекция ресурсов** | **API** |
|:------ | :------ |
| События в представлении (диапазоне дат) основного календаря | Функция [delta](../api-reference/v1.0/api/event_delta.md) ресурса [event](../api-reference/v1.0/resources/event.md) |
| Группы | Функция [delta](../api-reference/v1.0/api/group_delta.md) ресурса [group](../api-reference/v1.0/resources/group.md) |
| Папки почты | Функция [delta](../api-reference/v1.0/api/mailfolder_delta.md) ресурса [mailFolder](../api-reference/v1.0/resources/mailFolder.md) |
| Сообщения в папке | Функция [delta](../api-reference/v1.0/api/message_delta.md) ресурса [message](../api-reference/v1.0/resources/message.md) | 
| Папки личных контактов | Функция [delta](../api-reference/v1.0/api/contactfolder_delta.md) ресурса [contactFolder](../api-reference/v1.0/resources/contactfolder.md) |
| Личные контакты в папке | Функция [delta](../api-reference/v1.0/api/contact_delta.md) ресурса [contact](../api-reference/v1.0/resources/contact.md) |
| Пользователи | Функция [delta](../api-reference/v1.0/api/user_delta.md) ресурса [user](../api-reference/v1.0/resources/user.md) | 
| Элементы на диске\* | Функция [delta](../api-reference/v1.0/api/driveitem_delta.md) ресурса [driveItem](../api-reference/v1.0/resources/driveitem.md) |


> \* Небольшие различия в использовании ресурсов OneDrive и других поддерживаемых ресурсов касаются синтаксиса. Разностный запрос для ресурсов drive будет обновлен в соответствии с запросами для других типов ресурсов.  Дополнительные сведения о текущем синтаксисе см. в статье [Отслеживание изменений для Drive](https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/api/item_delta).

## <a name="prerequisites"></a>Предварительные условия

Выполнение разностных запросов для определенного ресурса требует тех же [разрешений](./permissions_reference.md), что и его чтение.

## <a name="delta-query-request-examples"></a>Примеры разностных запросов 

- [Получение добавочных изменений для событий в представлении календаря](../concepts/delta_query_events.md)
- [Получение добавочных изменений сообщений в папке](./delta_query_messages.md)
- [Получение добавочных изменений групп](./delta_query_groups.md)
- [Получение добавочных изменений пользователей](./delta_query_users.md)
