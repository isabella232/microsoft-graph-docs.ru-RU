#  <a name="use-delta-query-to-track-changes-in-microsoft-graph-data"></a><span data-ttu-id="47c85-101">Отслеживание изменений в данных Microsoft Graph с помощью разностного запроса</span><span class="sxs-lookup"><span data-stu-id="47c85-101">Use delta query to track changes in Microsoft Graph data</span></span>

<span data-ttu-id="47c85-p101">Запросы изменений позволяют приложениям обнаруживать новые, обновленные и удаленные сущности, не считывая целевой ресурс полностью при каждом запросе. Приложения Microsoft Graph могут использовать запросы изменений, чтобы эффективно синхронизировать изменения с локальным хранилищем данных.</span><span class="sxs-lookup"><span data-stu-id="47c85-p101">Delta query enables applications to discover newly created, updated, or deleted entities without performing a full read of the target resource with every request. Microsoft Graph applications can use delta query to efficiently synchronize changes with a local data store.</span></span>

## <a name="use-delta-query-to-track-changes-in-a-resource-collection"></a><span data-ttu-id="47c85-104">Отслеживание изменений в коллекции ресурсов с помощью запроса изменений</span><span class="sxs-lookup"><span data-stu-id="47c85-104">Use delta query to track changes in a resource collection</span></span>

<span data-ttu-id="47c85-105">Ниже представлен типичный шаблон вызова.</span><span class="sxs-lookup"><span data-stu-id="47c85-105">The typical call pattern is as follows:</span></span>

1.  <span data-ttu-id="47c85-106">Для начала приложение выполняет запрос GET с функцией delta для нужного ресурса.</span><span class="sxs-lookup"><span data-stu-id="47c85-106">The application begins by calling a GET request with the delta function on the desired resource.</span></span>
2.  <span data-ttu-id="47c85-107">Microsoft Graph отправит ответ, содержащий нужный ресурс и [маркер состояния](#state-tokens).</span><span class="sxs-lookup"><span data-stu-id="47c85-107">Microsoft Graph sends a response containing the requested resource and a [state token](#state-tokens).</span></span>

     <span data-ttu-id="47c85-p102">-  Если возвращается URL-адрес `nextLink`, это означает, что во время сеанса могли быть получены не все страницы данных. Для получения всех страниц данных приложение продолжает отправлять запросы, используя URL-адрес `nextLink`, пока в отклик не будет включен URL-адрес `deltaLink`.</span><span class="sxs-lookup"><span data-stu-id="47c85-p102">a.  If a `nextLink` URL is returned, there may be additional pages of data to be retrieved in the session. The application continues making requests using the `nextLink` URL to retrieve all pages of data until a `deltaLink` URL is returned in the response.</span></span>

     <span data-ttu-id="47c85-p103">- Если возвращается URL-адрес `deltaLink`, это означает, что больше нет данных о текущем состоянии ресурса. В последующих запросах приложение использует URL-адрес `deltaLink`, чтобы узнавать об изменениях ресурса.</span><span class="sxs-lookup"><span data-stu-id="47c85-p103">b.  If a `deltaLink` URL is returned, there is no more data about the existing state of the resource to be returned. For future requests, the application uses the `deltaLink` URL to learn about changes to the resource.</span></span>
     
3.  <span data-ttu-id="47c85-p104">Когда приложению требуется узнать об изменениях ресурса, оно совершает новый запрос, используя URL-адрес `deltaLink`, полученный на шаге 2. Этот запрос *может* быть совершен сразу по завершении шага 2 или когда приложение проверяет наличие изменений.</span><span class="sxs-lookup"><span data-stu-id="47c85-p104">When the application needs to learn about changes to the resource, it makes a new request using the `deltaLink` URL received in step 2. This request *may* be made immediately after completing step 2 or when the application checks for changes.</span></span>
4.  <span data-ttu-id="47c85-116">Microsoft Graph возвращает описание изменений ресурса с момента последнего запроса вместе с URL-адресом `nextLink` или `deltaLink`.</span><span class="sxs-lookup"><span data-stu-id="47c85-116">Microsoft Graph returns a response describing changes to the resource since the previous request, and either a `nextLink` URL or a `deltaLink` URL.</span></span>

### <a name="state-tokens"></a><span data-ttu-id="47c85-117">Маркеры состояния</span><span class="sxs-lookup"><span data-stu-id="47c85-117">State tokens</span></span>

<span data-ttu-id="47c85-p105">Ответ GET на запрос изменений всегда включает URL-адрес, указанный в заголовке `nextLink` или `deltaLink`. URL-адрес `nextLink` включает маркер _skipToken_, а URL-адрес `deltaLink` — _deltaToken_.</span><span class="sxs-lookup"><span data-stu-id="47c85-p105">A delta query GET response always includes a URL specified in a `nextLink` or `deltaLink` response header. The `nextLink` URL includes a _skipToken_, and a `deltaLink` URL includes a _deltaToken_.</span></span> 

<span data-ttu-id="47c85-p106">Эти маркеры непрозрачны для клиента. Вот что вам нужно знать о них:</span><span class="sxs-lookup"><span data-stu-id="47c85-p106">These tokens are opaque to the client. The following details are what you need to know about them:</span></span>

- <span data-ttu-id="47c85-122">Каждый маркер отражает состояние и представляет моментальный снимок ресурса в этом цикле отслеживания изменений.</span><span class="sxs-lookup"><span data-stu-id="47c85-122">Each token reflects the state and represents a snapshot of the resource in that round of change tracking.</span></span> 
- <span data-ttu-id="47c85-p107">Маркеры состояния также кодируют и включают другие параметры запроса (такие как `$select`), указанные в исходном запросе изменений. Таким образом, не обязательно повторять их в последующих запросах изменений.</span><span class="sxs-lookup"><span data-stu-id="47c85-p107">The state tokens also encode and include other query parameters (such as `$select`) specified in the initial delta query request. Therefore, it's not required to repeat them in subsequent delta query requests.</span></span>
- <span data-ttu-id="47c85-125">Совершая запрос изменений, вы можете скопировать и применить URL-адрес `nextLink` или `deltaLink` при следующем вызове функции **delta**, не проверяя содержимое URL-адреса, в том числе маркер состояния.</span><span class="sxs-lookup"><span data-stu-id="47c85-125">When carrying out delta query, you can copy and apply the `nextLink` or `deltaLink` URL to the next **delta** function call without having to inspect the contents of the URL, including its state token.</span></span>


### <a name="optional-query-parameters"></a><span data-ttu-id="47c85-126">Необязательные параметры запросов</span><span class="sxs-lookup"><span data-stu-id="47c85-126">Optional query parameters</span></span>

<span data-ttu-id="47c85-p108">Если клиент использует параметр запроса, он должен быть указан в исходном запросе. Microsoft Graph автоматически кодирует указанный параметр в ссылке `nextLink` или `deltaLink`, указанной в ответе. Вызывающему приложению достаточно один раз указать нужные параметры запроса. Microsoft Graph автоматически добавляет указанные параметры для всех последующих запросов.</span><span class="sxs-lookup"><span data-stu-id="47c85-p108">If a client uses a query parameter, it must be specified in the initial request. Microsoft Graph automatically encodes the specified parameter into the `nextLink` or `deltaLink` provided in the response. The calling application only needs to specify their desired query parameters once upfront. Microsoft Graph adds the specified parameters automatically for all subsequent requests.</span></span>

<span data-ttu-id="47c85-131">Для пользователей и групп действуют ограничения на применение некоторых параметров запросов:</span><span class="sxs-lookup"><span data-stu-id="47c85-131">For users and groups, there are restrictions on using some query parameters:</span></span>

-   <span data-ttu-id="47c85-p109">Если используется параметр запроса `$select`, это означает, что клиент предпочитает отслеживать изменения только для тех свойств или связей, которые указаны в операторе `$select`. При изменении свойства, которое не было выбрано, соответствующий ресурс не появится в отклике с различиями при последующем запросе.</span><span class="sxs-lookup"><span data-stu-id="47c85-p109">If a `$select` query parameter is used, the parameter indicates that the client prefers to only track changes on the properties or relationships specified in the `$select` statement. If a change occurs to a property that is not selected, the resource for which that property changed does not appear in the delta response after a subsequent request.</span></span>
-   <span data-ttu-id="47c85-134">Параметр `$expand` не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="47c85-134">`$expand` is not supported.</span></span>

<span data-ttu-id="47c85-p110">Бета-версии интерфейсов API (ознакомительные версии) поддерживают фильтры, позволяя отслеживать изменения для одного или нескольких пользователей либо групп с помощью objectId. Например, запрос https://graph.microsoft.com/beta/groups/delta/?$filter= id eq '477e9fc6-5de7-4406-bb2a-7e5c83c9ae5f' or id eq '004d6a07-fe70-4b92-add5-e6e37b8acd8e' вернет изменения для групп, идентификаторы которых соответствуют указанным в фильтре запроса.</span><span class="sxs-lookup"><span data-stu-id="47c85-p110">For users and groups beta (preview) APIs, scoping filters allow you to track changes to one or more specific users or groups by objectId. For example, the following request: https://graph.microsoft.com/beta/groups/delta/?$filter= id eq '477e9fc6-5de7-4406-bb2a-7e5c83c9ae5f' or id eq '004d6a07-fe70-4b92-add5-e6e37b8acd8e' returns changes for the groups matching the ids specified in the query filter.</span></span> 

## <a name="resource-representation-in-the-delta-query-response"></a><span data-ttu-id="47c85-137">Представление ресурсов в отклике на разностный запрос</span><span class="sxs-lookup"><span data-stu-id="47c85-137">Resource representation in the delta query response</span></span>

-   <span data-ttu-id="47c85-138">Новые экземпляры поддерживаемого ресурса представлены в ответе на запрос изменений с помощью стандартных свойств.</span><span class="sxs-lookup"><span data-stu-id="47c85-138">Newly created instances of a supported resource are represented in the delta query response using their standard representation.</span></span>

-   <span data-ttu-id="47c85-139">Обновленные экземпляры представлены **id** и *по крайней мере* обновленными свойствами, но могут быть включены и другие свойства.</span><span class="sxs-lookup"><span data-stu-id="47c85-139">Updated instances are represented by their **id** with *at least* the properties that have been updated, but additional properties may be included.</span></span>

-   <span data-ttu-id="47c85-p111">Связи между пользователями и группами представлены в виде заметок к стандартному представлению ресурса. Эти заметки представлены в формате `propertyName@delta`. Они включаются в отклик на исходный разностный запрос.</span><span class="sxs-lookup"><span data-stu-id="47c85-p111">Relationships on users and groups are represented as annotations on the standard resource representation. These annotations use the format `propertyName@delta`. The annotations are included in the response of the initial delta query request.</span></span>

<span data-ttu-id="47c85-p112">Удаленные экземпляры представлены только **id** и объектом `@removed`. Объект `@removed` может содержать дополнительные сведения о том, почему удален экземпляр. Например, "@removed": {"reason": "changed"}.</span><span class="sxs-lookup"><span data-stu-id="47c85-p112">Removed instances are represented by their **id** and an `@removed` object. The `@removed` object may include additional information about why the instance was removed. For example,  "@removed": {"reason": “changed”}.</span></span>

<span data-ttu-id="47c85-146">Возможные причины @removed: *changed* или *deleted*.</span><span class="sxs-lookup"><span data-stu-id="47c85-146">Possible @removed reasons can be *changed* or *deleted*.</span></span>
- <span data-ttu-id="47c85-147">*changed* указывает, что элемент удален и может быть восстановлен из [deletedItems](../api-reference/beta/resources/directory.md).</span><span class="sxs-lookup"><span data-stu-id="47c85-147">*Changed* indicates the item was deleted and can be restored from [deletedItems](../api-reference/beta/resources/directory.md).</span></span>
- <span data-ttu-id="47c85-148">*deleted* указывает, что элемент удален и не может быть восстановлен.</span><span class="sxs-lookup"><span data-stu-id="47c85-148">*Deleted* indicates the item is deleted and cannot be restored.</span></span>

<span data-ttu-id="47c85-p113">Объекты @removed могут возвращаться в отклике на исходный разностный запрос и в отслеживаемых откликах (deltaLink). Клиенты, использующие разностные запросы, должны иметь возможность обрабатывать эти объекты в откликах.</span><span class="sxs-lookup"><span data-stu-id="47c85-p113">@removed object can be returned in the initial delta query response and in tracked (deltaLink) responses. Clients using delta query requests should be designed to handle these object in the responses.</span></span>

## <a name="supported-resources"></a><span data-ttu-id="47c85-151">Поддерживаемые ресурсы</span><span class="sxs-lookup"><span data-stu-id="47c85-151">Supported resources</span></span>

<span data-ttu-id="47c85-152">Разностные запросы поддерживаются для указанных ниже ресурсов.</span><span class="sxs-lookup"><span data-stu-id="47c85-152">Delta query is currently supported for the following resources:</span></span>

| <span data-ttu-id="47c85-153">**Коллекция ресурсов**</span><span class="sxs-lookup"><span data-stu-id="47c85-153">**Resource collection**</span></span> | <span data-ttu-id="47c85-154">**API**</span><span class="sxs-lookup"><span data-stu-id="47c85-154">**API**</span></span> |
|:------ | :------ |
| <span data-ttu-id="47c85-155">События в представлении (диапазоне дат) основного календаря</span><span class="sxs-lookup"><span data-stu-id="47c85-155">Events in a calendar view (date range) of the primary calendar</span></span> | <span data-ttu-id="47c85-156">Функция [delta](../api-reference/v1.0/api/event_delta.md) ресурса [event](../api-reference/v1.0/resources/event.md)</span><span class="sxs-lookup"><span data-stu-id="47c85-156">[delta](../api-reference/v1.0/api/event_delta.md) function of the [event](../api-reference/v1.0/resources/event.md) resource</span></span> |
| <span data-ttu-id="47c85-157">Группы</span><span class="sxs-lookup"><span data-stu-id="47c85-157">Groups</span></span> | <span data-ttu-id="47c85-158">Функция [delta](../api-reference/v1.0/api/group_delta.md) ресурса [group](../api-reference/v1.0/resources/group.md)</span><span class="sxs-lookup"><span data-stu-id="47c85-158">[delta](../api-reference/v1.0/api/group_delta.md) function of the [group](../api-reference/v1.0/resources/group.md) resource</span></span> |
| <span data-ttu-id="47c85-159">Папки почты</span><span class="sxs-lookup"><span data-stu-id="47c85-159">Mail folders</span></span> | <span data-ttu-id="47c85-160">Функция [delta](../api-reference/v1.0/api/mailfolder_delta.md) ресурса [mailFolder](../api-reference/v1.0/resources/mailFolder.md)</span><span class="sxs-lookup"><span data-stu-id="47c85-160">[delta](../api-reference/v1.0/api/mailfolder_delta.md) function of the [mailFolder](../api-reference/v1.0/resources/mailFolder.md) resource</span></span> |
| <span data-ttu-id="47c85-161">Сообщения в папке</span><span class="sxs-lookup"><span data-stu-id="47c85-161">Messages in a folder</span></span> | <span data-ttu-id="47c85-162">Функция [delta](../api-reference/v1.0/api/message_delta.md) ресурса [message](../api-reference/v1.0/resources/message.md)</span><span class="sxs-lookup"><span data-stu-id="47c85-162">[delta](../api-reference/v1.0/api/message_delta.md) function of the [message](../api-reference/v1.0/resources/message.md) resource</span></span> | 
| <span data-ttu-id="47c85-163">Папки личных контактов</span><span class="sxs-lookup"><span data-stu-id="47c85-163">Personal contact folders</span></span> | <span data-ttu-id="47c85-164">Функция [delta](../api-reference/v1.0/api/contactfolder_delta.md) ресурса [contactFolder](../api-reference/v1.0/resources/contactfolder.md)</span><span class="sxs-lookup"><span data-stu-id="47c85-164">[delta](../api-reference/v1.0/api/contactfolder_delta.md) function of the [contactFolder](../api-reference/v1.0/resources/contactfolder.md) resource</span></span> |
| <span data-ttu-id="47c85-165">Личные контакты в папке</span><span class="sxs-lookup"><span data-stu-id="47c85-165">Personal contacts in a folder</span></span> | <span data-ttu-id="47c85-166">Функция [delta](../api-reference/v1.0/api/contact_delta.md) ресурса [contact](../api-reference/v1.0/resources/contact.md)</span><span class="sxs-lookup"><span data-stu-id="47c85-166">[delta](../api-reference/v1.0/api/contact_delta.md) function of the [contact](../api-reference/v1.0/resources/contact.md) resource</span></span> |
| <span data-ttu-id="47c85-167">Пользователи</span><span class="sxs-lookup"><span data-stu-id="47c85-167">Users</span></span> | <span data-ttu-id="47c85-168">Функция [delta](../api-reference/v1.0/api/user_delta.md) ресурса [user](../api-reference/v1.0/resources/user.md)</span><span class="sxs-lookup"><span data-stu-id="47c85-168">[delta](../api-reference/v1.0/api/user_delta.md) function of the [user](../api-reference/v1.0/resources/user.md) resource</span></span> | 
| <span data-ttu-id="47c85-169">Элементы на диске\*</span><span class="sxs-lookup"><span data-stu-id="47c85-169">Drive items\*</span></span> | <span data-ttu-id="47c85-170">Функция [delta](../api-reference/v1.0/api/item_delta.md) ресурса [driveItem](../api-reference/v1.0/resources/driveItem.md)</span><span class="sxs-lookup"><span data-stu-id="47c85-170">[delta](../api-reference/v1.0/api/item_delta.md) function of the [driveItem](../api-reference/v1.0/resources/driveItem.md) resource</span></span> |


> <span data-ttu-id="47c85-p114">\* Небольшие различия в использовании ресурсов OneDrive и других поддерживаемых ресурсов касаются синтаксиса. Разностный запрос для ресурсов drive будет обновлен в соответствии с использованием других типов ресурсов. Дополнительные сведения о текущем синтаксисе см. на странице <https://developer.microsoft.com/ru-ru/graph/docs/api-reference/v1.0/api/item_delta></span><span class="sxs-lookup"><span data-stu-id="47c85-p114">\* The usage pattern for OneDrive resources is similar to the other supported resources with some minor syntax differences. Delta query for drives will be updated in the future to be consistent with other resource types. For more detail about the current syntax, please see: <https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/api/item_delta></span></span>

## <a name="prerequisites"></a><span data-ttu-id="47c85-174">Требования</span><span class="sxs-lookup"><span data-stu-id="47c85-174">Prerequisites</span></span>

<span data-ttu-id="47c85-175">Выполнение разностных запросов для определенного ресурса требует тех же [разрешений](./permissions_reference.md), что и его чтение.</span><span class="sxs-lookup"><span data-stu-id="47c85-175">The same [permissions](./permissions_reference.md) that are required to read a specific resource are also required to perform delta query on that resource.</span></span>

## <a name="delta-query-request-examples"></a><span data-ttu-id="47c85-176">Примеры разностных запросов</span><span class="sxs-lookup"><span data-stu-id="47c85-176">Delta query request examples</span></span> 

- [<span data-ttu-id="47c85-177">Получение добавочных изменений для событий в представлении календаря</span><span class="sxs-lookup"><span data-stu-id="47c85-177">Get incremental changes to events in a calendar view</span></span>](../concepts/delta_query_events.md)
- [<span data-ttu-id="47c85-178">Получение добавочных изменений сообщений в папке</span><span class="sxs-lookup"><span data-stu-id="47c85-178">Get incremental changes to messages in a folder</span></span>](./delta_query_messages.md)
- [<span data-ttu-id="47c85-179">Получение добавочных изменений групп</span><span class="sxs-lookup"><span data-stu-id="47c85-179">Get incremental changes to groups</span></span>](./delta_query_groups.md)
- [<span data-ttu-id="47c85-180">Получение добавочных изменений пользователей</span><span class="sxs-lookup"><span data-stu-id="47c85-180">Get incremental changes to users</span></span>](./delta_query_users.md)
