---
title: Интеграция оповещений API безопасности Microsoft Graph с SIEM при помощи Azure Monitor
description: Поставщиками безопасности Microsoft Graph можно управлять через одну конечную точку REST. Эту конечную точку можно настроить для службы Azure Monitor, поддерживающей соединители для нескольких продуктов SIEM. Инструкции, приведенные в этапах 1 и 2 этой статьи, относятся ко всем соединителям Azure Monitor, поддерживающим получение данных через концентраторы событий. В этой статье описана сквозная интеграция соединителя Splunk SIEM.
author: preetikr
localization_priority: Priority
ms.prod: security
ms.openlocfilehash: f411bbbfbedd1e692489b3dcb995e9d34bfab203
ms.sourcegitcommit: 0ce657622f42c510a104156a96bf1f1f040bc1cd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/24/2019
ms.locfileid: "32584952"
---
# <a name="integrate-microsoft-graph-security-api-alerts-with-your-siem-using-azure-monitor"></a><span data-ttu-id="34cc8-106">Интеграция оповещений API безопасности Microsoft Graph с SIEM при помощи Azure Monitor</span><span class="sxs-lookup"><span data-stu-id="34cc8-106">Integrate Microsoft Graph Security API alerts with your SIEM using Azure Monitor</span></span>

<span data-ttu-id="34cc8-107">Поставщиками безопасности Microsoft Graph можно управлять через одну конечную точку REST.</span><span class="sxs-lookup"><span data-stu-id="34cc8-107">The Microsoft Graph Security providers can be managed through a single REST endpoint.</span></span> <span data-ttu-id="34cc8-108">Эту конечную точку можно настроить для службы [Azure Monitor](https://docs.microsoft.com/ru-RU/azure/monitoring-and-diagnostics/), поддерживающей соединители для нескольких продуктов SIEM.</span><span class="sxs-lookup"><span data-stu-id="34cc8-108">This endpoint can be configured to [Azure Monitor](https://docs.microsoft.com/ru-RU/azure/monitoring-and-diagnostics/) which supports connectors to several SIEM products.</span></span> <span data-ttu-id="34cc8-109">Инструкции, приведенные в этапах 1 и 2 этой статьи, относятся ко всем соединителям Azure Monitor, поддерживающим получение данных через концентраторы событий.</span><span class="sxs-lookup"><span data-stu-id="34cc8-109">The instructions in Steps 1 and 2 of this article refer to all Azure Monitor connectors that support consumption via event hubs.</span></span> <span data-ttu-id="34cc8-110">В этой статье описана сквозная интеграция соединителя [Splunk](https://splunkbase.splunk.com/) SIEM.</span><span class="sxs-lookup"><span data-stu-id="34cc8-110">This article describes the end-to-end integration of the [Splunk](https://splunkbase.splunk.com/) SIEM connector.</span></span>

<span data-ttu-id="34cc8-111">Процесс интеграции состоит из следующих этапов:</span><span class="sxs-lookup"><span data-stu-id="34cc8-111">The integration process involves the following steps:</span></span>

1. [<span data-ttu-id="34cc8-112">Настройка концентратора событий Azure на получение оповещений системы безопасности для клиента</span><span class="sxs-lookup"><span data-stu-id="34cc8-112">Set up Azure event hub to receive security alerts for your tenant</span></span>](#step-1-set-up-an-event-hubs-namespace-in-azure-to-receive-security-alerts-for-your-tenant)
2. [<span data-ttu-id="34cc8-113">Настройка Azure Monitor на отправку оповещений системы безопасности из клиента в концентратор событий</span><span class="sxs-lookup"><span data-stu-id="34cc8-113">Configure Azure Monitor to send security alerts from your tenant to the event hub</span></span>](#step-2-configure-azure-monitor-to-send-security-alerts-from-your-tenant-to-the-event-hub)
3. [<span data-ttu-id="34cc8-114">Скачивание и установка надстройки Azure Monitor для Splunk, с помощью которой Splunk может получать оповещения системы безопасности</span><span class="sxs-lookup"><span data-stu-id="34cc8-114">Download and install the Azure Monitor Add-on for Splunk which will allow Splunk to consume security alerts</span></span>](#step-3-download-and-install-the-azure-monitor-add-on-for-splunk-which-will-allow-splunk-to-consume-security-alerts)
4. [<span data-ttu-id="34cc8-115">Регистрация приложения в клиенте Azure Active Directory, с помощью которого Splunk будет считывать данные из концентратора событий</span><span class="sxs-lookup"><span data-stu-id="34cc8-115">Register an application with your tenant Azure Active Directory which Splunk will use to read from the event hub</span></span>](#step-4-register-an-application-with-your-tenant-azure-active-directory-which-splunk-will-use-to-read-from-the-event-hub )
5. [<span data-ttu-id="34cc8-116">Создание хранилища Azure Key Vault для хранения ключа доступа к концентратору событий</span><span class="sxs-lookup"><span data-stu-id="34cc8-116">Create an Azure Key vault to store the access key for the event hub</span></span>](#step-5-create-an-azure-key-vault-to-store-the-access-key-for-the-event-hub)
6. [<span data-ttu-id="34cc8-117">Настройка каналов входных данных Splunk на получение оповещений системы безопасности, хранящихся в концентраторе событий</span><span class="sxs-lookup"><span data-stu-id="34cc8-117">Configure the Splunk data inputs to consume security alerts stored in the event hub</span></span>](#step-6-configure-the-splunk-data-inputs-to-consume-security-alerts-stored-in-the-event-hub)

<span data-ttu-id="34cc8-118">После выполнения этих действий Splunk Enterprise будет получать оповещения системы безопасности от всех интегрированных с Microsoft Graph средств обеспечения безопасности, лицензии на которые есть в клиенте.</span><span class="sxs-lookup"><span data-stu-id="34cc8-118">After you complete these steps, your Splunk Enterprise will consume security alerts from all the Microsoft Graph integrated security products for which your tenant is licensed.</span></span> <span data-ttu-id="34cc8-119">Все новые лицензированные средства обеспечения безопасности также будут отправлять оповещения через это соединение по той же схеме. Дополнительная интеграция не требуется.</span><span class="sxs-lookup"><span data-stu-id="34cc8-119">Any new security products that you license will also send alerts through this connection, in the same schema with no further integration work needed.</span></span>

## <a name="step-1-set-up-an-event-hubs-namespace-in-azure-to-receive-security-alerts-for-your-tenant"></a><span data-ttu-id="34cc8-120">Этап 1. Настройка пространства имен для концентраторов событий в Azure на получение оповещений системы безопасности для клиента</span><span class="sxs-lookup"><span data-stu-id="34cc8-120">Step 1: Set up an Event Hubs namespace in Azure to receive security alerts for your tenant</span></span>

<span data-ttu-id="34cc8-121">Для начала необходимо создать пространство имен [концентраторов событий Microsoft Azure](https://docs.microsoft.com/ru-RU/azure/event-hubs/) и концентратор событий.</span><span class="sxs-lookup"><span data-stu-id="34cc8-121">To begin, you need to create a [Microsoft Azure Event Hubs](https://docs.microsoft.com/ru-RU/azure/event-hubs/) namespace and event hub.</span></span> <span data-ttu-id="34cc8-122">Это пространство имен и концентратор событий будут пунктом назначения для всех оповещений системы безопасности в организации.</span><span class="sxs-lookup"><span data-stu-id="34cc8-122">This namespace and event hub is the destination for all your organization’s security alerts.</span></span> <span data-ttu-id="34cc8-123">Пространство имен концентраторов событий — это логическая группа концентраторов событий с одной и той же политикой доступа.</span><span class="sxs-lookup"><span data-stu-id="34cc8-123">An Event Hubs namespace is a logical grouping of event hubs that share the same access policy.</span></span> <span data-ttu-id="34cc8-124">Обратите внимание на несколько особенностей этого пространства имен и создаваемых вами концентраторов событий.</span><span class="sxs-lookup"><span data-stu-id="34cc8-124">Note a few details about the Event Hubs namespace and event hubs that you create:</span></span>

- <span data-ttu-id="34cc8-125">Рекомендуем использовать стандартное пространство имен концентраторов событий, особенно при отправке других данных мониторинга Azure через те же концентраторы событий.</span><span class="sxs-lookup"><span data-stu-id="34cc8-125">We recommend using a Standard Event Hubs namespace, particularly if you are sending other Azure monitoring data through these same event hubs.</span></span>
- <span data-ttu-id="34cc8-126">Как правило, требуется только одна единица пропускной способности.</span><span class="sxs-lookup"><span data-stu-id="34cc8-126">Typically, only one throughput unit is necessary.</span></span> <span data-ttu-id="34cc8-127">Если активность использования концентратора повысится, вы можете вручную увеличивать количество единиц пропускной способности для пространства имен или включить автоматическое расширение.</span><span class="sxs-lookup"><span data-stu-id="34cc8-127">If you need to scale up as your usage increases, you can always manually increase the number of throughput units for the namespace later or enable auto inflation.</span></span>
- <span data-ttu-id="34cc8-128">Количество единиц пропускной способности позволяет повышать масштаб пропускной способности для концентраторов событий.</span><span class="sxs-lookup"><span data-stu-id="34cc8-128">The number of throughput units allows you to increase throughput scale for your event hubs.</span></span> <span data-ttu-id="34cc8-129">Путем изменения количества разделов вы можете параллелизовать потребление для множества пользователей.</span><span class="sxs-lookup"><span data-stu-id="34cc8-129">The number of partitions allows you to parallelize consumption across many consumers.</span></span> <span data-ttu-id="34cc8-130">Скорость одного раздела может достигать 20 МБ/с или приблизительно 20 000 сообщений в секунду.</span><span class="sxs-lookup"><span data-stu-id="34cc8-130">A single partition can do up to 20MBps, or approximately 20,000 messages per second.</span></span> <span data-ttu-id="34cc8-131">Поддержка получения данных из нескольких разделов зависит от того, какое средство получает данные.</span><span class="sxs-lookup"><span data-stu-id="34cc8-131">Depending on the tool consuming the data, it may or may not support consuming from multiple partitions.</span></span> <span data-ttu-id="34cc8-132">Если вы не уверены, сколько разделов следует создать, рекомендуем начать с четырех.</span><span class="sxs-lookup"><span data-stu-id="34cc8-132">If you're not sure about the number of partitions to set, we recommend starting with four partitions.</span></span>
- <span data-ttu-id="34cc8-133">Рекомендуем задать для концентратора событий срок хранения сообщений, составляющий 7 дней.</span><span class="sxs-lookup"><span data-stu-id="34cc8-133">We recommend that you set message retention on your event hub to 7 days.</span></span> <span data-ttu-id="34cc8-134">Благодаря этому, если средство получения данных выйдет из строя более чем на день, оно сможет продолжить работу с того же момента (для событий не старше 7 дней).</span><span class="sxs-lookup"><span data-stu-id="34cc8-134">If your consuming tool goes down for more than a day, this ensures that the tool can pick up where it left off (for events up to 7 days old).</span></span>
- <span data-ttu-id="34cc8-135">Рекомендуем использовать для концентратора событий группу потребителей по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="34cc8-135">We recommend using the default consumer group for your event hub.</span></span> <span data-ttu-id="34cc8-136">Создавать другие группы потребителей или использовать отдельную группу не требуется, если вы не планируете получать данные из одного концентратора событий с помощью двух разных средств.</span><span class="sxs-lookup"><span data-stu-id="34cc8-136">You don't need to create other consumer groups or use a separate consumer group unless you plan to have two different tools consume the same data from the same event hub.</span></span>
- <span data-ttu-id="34cc8-137">Как правило, на компьютере, получающем данные из концентратора событий, должны быть открыты порты 5671 и 5672.</span><span class="sxs-lookup"><span data-stu-id="34cc8-137">Typically, port 5671 and 5672 must be opened on the machine consuming data from the event hub.</span></span>

<span data-ttu-id="34cc8-138">См. также: [Часто задаваемые вопросы о концентраторах событий в Azure](https://docs.microsoft.com/ru-RU/azure/event-hubs/event-hubs-faq).</span><span class="sxs-lookup"><span data-stu-id="34cc8-138">Also see the [Azure Event Hubs FAQ](https://docs.microsoft.com/ru-RU/azure/event-hubs/event-hubs-faq).</span></span>

1. <span data-ttu-id="34cc8-139">Войдите на [портал Azure](https://portal.azure.com/) и нажмите **Создать ресурс** в левой верхней части экрана.</span><span class="sxs-lookup"><span data-stu-id="34cc8-139">Log on to the [Azure portal](https://portal.azure.com/) and choose **Create a resource** at the top left of the screen.</span></span>

    ![Изображение кнопки для создания ресурса](images/create-resource.png)

2. <span data-ttu-id="34cc8-141">Выберите **"Интернет вещей"**, а затем — **Концентраторы событий**.</span><span class="sxs-lookup"><span data-stu-id="34cc8-141">Select **Internet of Things** and choose **Event Hubs**.</span></span>

    ![Изображение концентраторов событий](images/event-hubs.png)

3. <span data-ttu-id="34cc8-143">В поле **Создать пространство имен** введите имя пространства имен.</span><span class="sxs-lookup"><span data-stu-id="34cc8-143">In **Create namespace**, enter a namespace name.</span></span> <span data-ttu-id="34cc8-144">Убедившись, что имя пространства имен доступно, выберите ценовую категорию (базовую или стандартную).</span><span class="sxs-lookup"><span data-stu-id="34cc8-144">After making sure the namespace name is available, choose the pricing tier (Basic or Standard).</span></span> <span data-ttu-id="34cc8-145">Кроме того, выберите подписку Azure, группу ресурсов и расположение для создания ресурса.</span><span class="sxs-lookup"><span data-stu-id="34cc8-145">Also, choose an Azure subscription, resource group, and location in which to create the resource.</span></span> <span data-ttu-id="34cc8-146">Нажмите кнопку **Создать**, чтобы создать пространство имен.</span><span class="sxs-lookup"><span data-stu-id="34cc8-146">Choose **Create** to create the namespace.</span></span> <span data-ttu-id="34cc8-147">Возможно, вам потребуется подождать несколько минут, чтобы система полностью подготовила ресурсы.</span><span class="sxs-lookup"><span data-stu-id="34cc8-147">You might have to wait a few minutes for the system to fully provision the resources.</span></span>

    ![Изображение окна для создания пространства имен](images/create-namespace.png)

## <a name="step-2-configure-azure-monitor-to-send-security-alerts-from-your-tenant-to-the-event-hub"></a><span data-ttu-id="34cc8-149">Этап 2. Настройка Azure Monitor на отправку оповещений системы безопасности из клиента в концентратор событий</span><span class="sxs-lookup"><span data-stu-id="34cc8-149">Step 2: Configure Azure Monitor to send security alerts from your tenant to the event hub</span></span>

<span data-ttu-id="34cc8-150">Достаточно один раз включить потоковую передачу оповещений от системы безопасности организации через Azure Monitor для всего клиента Azure Active Directory (Azure AD).</span><span class="sxs-lookup"><span data-stu-id="34cc8-150">Enabling the streaming of your organization’s security alerts through Azure Monitor is done one time for your entire Azure Active Directory (Azure AD) tenant.</span></span> <span data-ttu-id="34cc8-151">Все продукты с поддержкой и лицензией на API безопасности Microsoft Graph начнут отправлять оповещения системы безопасности в Azure Monitor, выполняя потоковую передачу данных принимающим приложениям.</span><span class="sxs-lookup"><span data-stu-id="34cc8-151">All Microsoft Graph Security API licensed and enabled products will begin sending security alerts to Azure Monitor, streaming data to consuming applications.</span></span> <span data-ttu-id="34cc8-152">Все остальные продукты с поддержкой API безопасности Microsoft Graph, лицензированные и развернутые в организации, автоматически начнут потоковую передачу оповещений системы безопасности с использованием той же конфигурации Azure Monitor.</span><span class="sxs-lookup"><span data-stu-id="34cc8-152">Any additional Microsoft Graph Security API-enabled products licensed and deployed by your organization will automatically stream security alerts through this same Azure Monitor configuration.</span></span> <span data-ttu-id="34cc8-153">От организации не потребуется дополнительных действий по интеграции.</span><span class="sxs-lookup"><span data-stu-id="34cc8-153">No further integration work is needed from the organization.</span></span>

<span data-ttu-id="34cc8-154">Оповещения системы безопасности обладают широкими правами, и их обычно могут просматривать только сотрудники групп реагирования и глобальные администраторы организации.</span><span class="sxs-lookup"><span data-stu-id="34cc8-154">Security alerts are highly privileged data typically viewable only by security response personnel and global administrators within an organization.</span></span> <span data-ttu-id="34cc8-155">По этой причине, чтобы настроить интеграцию оповещений системы безопасности в клиенте с системами SIEM, необходима учетная запись глобального администратора Azure AD.</span><span class="sxs-lookup"><span data-stu-id="34cc8-155">For this reason, the steps required to configure the integration of a tenant’s security alerts with SIEM systems require an Azure AD Global Administrator account.</span></span> <span data-ttu-id="34cc8-156">Эта учетная запись потребуется только один раз, во время настройки, чтобы запросить отправку оповещений от службы безопасности организации в Azure Monitor.</span><span class="sxs-lookup"><span data-stu-id="34cc8-156">This account is only needed one time, during setup, to request your organization’s security alerts be sent to Azure Monitor.</span></span>

> <span data-ttu-id="34cc8-157">**Примечание.** В настоящее время колонка параметров диагностики в Azure Monitor не поддерживает настройку ресурсов на уровне клиента.</span><span class="sxs-lookup"><span data-stu-id="34cc8-157">**Note:** Currently, the Azure Monitor Diagnostic settings blade does not support configuration of tenant-level resources.</span></span> <span data-ttu-id="34cc8-158">Оповещения API безопасности Microsoft Graph являются ресурсом на уровне клиента, что требует использования API Azure Resource Manager, чтобы настроить Azure Monitor на поддержку получения оповещений от системы безопасности организации.</span><span class="sxs-lookup"><span data-stu-id="34cc8-158">Microsoft Graph Security API alerts are a tenant-level resource, which requires using the Azure Resource Manager API to configure Azure Monitor to support consumption of your organization’s security alerts.</span></span>

1. <span data-ttu-id="34cc8-159">В подписке Azure зарегистрируйте "microsoft.insights" (Azure Monitor) в качестве поставщика ресурсов.</span><span class="sxs-lookup"><span data-stu-id="34cc8-159">In your Azure subscription, register "microsoft.insights" (Azure Monitor) as a resource provider.</span></span>  
 > <span data-ttu-id="34cc8-160">**Примечание.** Не указывайте "Microsoft.SecurityGraph" (API безопасности Microsoft Graph) в качестве поставщика ресурсов в своей подписке Azure, поскольку "Microsoft.SecurityGraph" является ресурсом на уровне клиента, как указано выше.</span><span class="sxs-lookup"><span data-stu-id="34cc8-160">**Note:** Do not register "Microsoft.SecurityGraph" (Microsoft Graph Security API) as a resource provider in your Azure subscription, as “Microsoft.SecurityGraph” is a tenant-level resource as explained above.</span></span> <span data-ttu-id="34cc8-161">Настройка на уровне клиента рассматривается в п. 6 ниже.</span><span class="sxs-lookup"><span data-stu-id="34cc8-161">Tenant level configuration will be part of #6 below.</span></span>

2. <span data-ttu-id="34cc8-162">Чтобы настроить Azure Monitor с помощью API Azure Resource Manager, приобретите средство [ARMClient](https://github.com/projectkudu/ARMClient).</span><span class="sxs-lookup"><span data-stu-id="34cc8-162">To configure Azure Monitor using the Azure Resource Manager API, obtain the [ARMClient](https://github.com/projectkudu/ARMClient) tool.</span></span> <span data-ttu-id="34cc8-163">С его помощью можно отправлять вызовы REST API на портал Azure из командной строки.</span><span class="sxs-lookup"><span data-stu-id="34cc8-163">This tool will be used to send REST API calls to the Azure portal from a command line.</span></span>

3. <span data-ttu-id="34cc8-164">Подготовьте примерно такой файл JSON с запросом параметров диагностики:</span><span class="sxs-lookup"><span data-stu-id="34cc8-164">Prepare a diagnostic setting request JSON file like the following:</span></span>

<!-- {
  "blockType": "ignored"
} -->

    ``` json
    {
      "location": "",
      "properties": {
        "name": "securityApiAlerts",
        "serviceBusRuleId": "/subscriptions/SUBSCRIPTION_ID/resourceGroups/RESOURCE_GROUP/providers/Microsoft.EventHub/namespaces/EVENT_HUB_NAMESPACE/authorizationrules/RootManageSharedAccessKey",
        "logs": [
          {
            "category": "Alert",
            "enabled": true,
            "retentionPolicy": {
              "enabled": true,
              "days": 7
            }
          }
        ]
      }
    }
    ```

  <span data-ttu-id="34cc8-165">Замените значения в файле JSON, как указано ниже.</span><span class="sxs-lookup"><span data-stu-id="34cc8-165">Replace the values in the JSON file as follows:</span></span>

  * <span data-ttu-id="34cc8-166">**SUBSCRIPTION_ID** — это ИД подписки Azure, где размещаются группа ресурсов и пространство имен концентраторов событий, в которые будут отправляться оповещения системы безопасности из вашей организации.</span><span class="sxs-lookup"><span data-stu-id="34cc8-166">**SUBSCRIPTION_ID** is the Subscription ID of the Azure subscription hosting the resource group and event hub namespace where you will be sending security alerts from your organization.</span></span>
  * <span data-ttu-id="34cc8-167">**RESOURCE_GROUP** — это группа ресурсов, содержащая пространство имен концентраторов событий, в которое будут отправляться оповещения системы безопасности из вашей организации.</span><span class="sxs-lookup"><span data-stu-id="34cc8-167">**RESOURCE_GROUP** is the resource group containing the event hub namespace where you will be sending security alerts from your organization.</span></span>
  * <span data-ttu-id="34cc8-168">**EVENT_HUB_NAMESPACE** — это пространство концентраторов событий, в которое будут отправляться оповещения системы безопасности из вашей организации.</span><span class="sxs-lookup"><span data-stu-id="34cc8-168">**EVENT_HUB_NAMESPACE** is the event hub namespace where you will be sending security alerts from your organization.</span></span>
  * <span data-ttu-id="34cc8-169">**"days"** — это количество дней, в течение которого в концентраторе событий будут храниться сообщения.</span><span class="sxs-lookup"><span data-stu-id="34cc8-169">**“days”:** is the number of days you want to retain messages in your event hub.</span></span>
  
&nbsp;
4. <span data-ttu-id="34cc8-170">Сохраните файл в формате JSON в том же каталоге, где будет запускаться программа ARMClient.exe.</span><span class="sxs-lookup"><span data-stu-id="34cc8-170">Save the file as JSON to the directory where you will invoke ARMClient.exe.</span></span> <span data-ttu-id="34cc8-171">Например, назовите файл **AzMonConfig.json.**</span><span class="sxs-lookup"><span data-stu-id="34cc8-171">For example, name the file **AzMonConfig.json.**</span></span>

5. <span data-ttu-id="34cc8-172">Выполните приведенную ниже команду, чтобы войти в средство ARMClient.</span><span class="sxs-lookup"><span data-stu-id="34cc8-172">Run the following command to sigh in to the ARMClient tool.</span></span> <span data-ttu-id="34cc8-173">Необходимо использовать учетные данные глобального администратора.</span><span class="sxs-lookup"><span data-stu-id="34cc8-173">You will need to be using Global Administrator account credentials.</span></span>

    ``` shell
    ARMClient.exe login
    ```

6. <span data-ttu-id="34cc8-174">Выполните приведенную ниже команду, чтобы настроить Azure Monitor на отправку оповещений системы безопасности в пространство имен концентраторов событий.</span><span class="sxs-lookup"><span data-stu-id="34cc8-174">Run the following command to configure Azure Monitor to send security alerts to your event hub namespace.</span></span> <span data-ttu-id="34cc8-175">При этом в пространстве имен будет автоматически подготовлен концентратор событий, в который будет запущен поток оповещений системы безопасности.</span><span class="sxs-lookup"><span data-stu-id="34cc8-175">This will automatically provision an event hub within the namespace and start the flow of security alerts into the event hub.</span></span> <span data-ttu-id="34cc8-176">Убедитесь, что имя параметра (в данном примере — **securityApiAlerts**) совпадает с указанным в поле **name** JSON-файла.</span><span class="sxs-lookup"><span data-stu-id="34cc8-176">Ensure that the setting name (in this example, **securityApiAlerts**) matches the setting name you specified in the JSON file for the **name** field.</span></span>

    ``` shell
    ARMClient.exe put https://management.azure.com/providers/Microsoft.SecurityGraph/diagnosticSettings/securityApiAlerts?api-version=2017-04-01-preview  @".\AzMonConfig.json"
    ```

7. <span data-ttu-id="34cc8-177">Чтобы убедиться, что параметры применены должным образом, выполните приведенную ниже команду и убедитесь, что выходные данные совпадают с параметрами из JSON-файла.</span><span class="sxs-lookup"><span data-stu-id="34cc8-177">To verify the settings were applied correctly, run this command and verify that the output matches your JSON file settings.</span></span>

    ``` shell
    ARMClient.exe get https://management.azure.com/providers/Microsoft.SecurityGraph/diagnosticSettings/securityApiAlerts?api-version=2017-04-01-preview
    ```

8. <span data-ttu-id="34cc8-178">Закройте средство ARMClient.</span><span class="sxs-lookup"><span data-stu-id="34cc8-178">Exit the ARMClient tool.</span></span> <span data-ttu-id="34cc8-179">Теперь Azure Monitor настроен на отправку оповещений системы безопасности из клиента в концентратор событий.</span><span class="sxs-lookup"><span data-stu-id="34cc8-179">You have now completed the configuration of Azure Monitor to send security alerts from your tenant to event hub.</span></span>

## <a name="step-3-download-and-install-the-azure-monitor-add-on-for-splunk-which-will-allow-splunk-to-consume-security-alerts"></a><span data-ttu-id="34cc8-180">Этап 3. Скачивание и установка надстройки Azure Monitor для Splunk, с помощью которой Splunk может получать оповещения системы безопасности</span><span class="sxs-lookup"><span data-stu-id="34cc8-180">Step 3: Download and install the Azure Monitor Add-on for Splunk which will allow Splunk to consume security alerts</span></span>

1. <span data-ttu-id="34cc8-181">Эта интеграция поддерживает только развертывания [Splunk Enterprise](https://splunkbase.splunk.com/).</span><span class="sxs-lookup"><span data-stu-id="34cc8-181">This integration only supports [Splunk Enterprise](https://splunkbase.splunk.com/) deployments.</span></span>
2. <span data-ttu-id="34cc8-182">Скачайте и установите [Надстройку Azure Monitor для Splunk](https://github.com/Microsoft/AzureMonitorAddonForSplunk).</span><span class="sxs-lookup"><span data-stu-id="34cc8-182">Download and install the [Azure Monitor Add-on for Splunk](https://github.com/Microsoft/AzureMonitorAddonForSplunk).</span></span> <span data-ttu-id="34cc8-183">Подробные инструкции по установке и см. в статье [Установка](https://github.com/Microsoft/AzureMonitorAddonForSplunk/wiki/Installation).</span><span class="sxs-lookup"><span data-stu-id="34cc8-183">For detailed installation instructions, see [Installation](https://github.com/Microsoft/AzureMonitorAddonForSplunk/wiki/Installation).</span></span> <span data-ttu-id="34cc8-184">**Поддерживается только надстройка Azure Monitor для Splunk версии 1.2.9 или более поздней.**</span><span class="sxs-lookup"><span data-stu-id="34cc8-184">**Only Azure Monitor Add-on for Splunk version 1.2.9 or higher is supported.**</span></span>
3. <span data-ttu-id="34cc8-185">После успешной установки надстройки, выполните действия по настройке, описанные в вики-статье [Конфигурация надстройки Azure Monitor](https://github.com/Microsoft/AzureMonitorAddonForSplunk/wiki/Configuration-of-Splunk ), чтобы настроить Splunk.</span><span class="sxs-lookup"><span data-stu-id="34cc8-185">After successfully installing the Add-on, follow the configuration steps described in the [Azure Monitor add-on configuration wiki](https://github.com/Microsoft/AzureMonitorAddonForSplunk/wiki/Configuration-of-Splunk ) to configure Splunk.</span></span>
4. <span data-ttu-id="34cc8-186">Как указано в инструкциях по установке надстройки, она будет работать при помощи цикла отключения и включения на странице "Управление приложениями" сайта Splunk.</span><span class="sxs-lookup"><span data-stu-id="34cc8-186">As indicated in the Add-on installation instructions, the add-on will work by doing a disable/enable cycle on the Manage Apps page in Splunk Web.</span></span> <span data-ttu-id="34cc8-187">Вы также можете перезапустить Splunk.</span><span class="sxs-lookup"><span data-stu-id="34cc8-187">Or, you can restart Splunk.</span></span>

## <a name="step-4-register-an-application-with-your-tenant-azure-active-directory-which-splunk-will-use-to-read-from-the-event-hub"></a><span data-ttu-id="34cc8-188">Этап 4. Регистрация приложения в клиенте Azure Active Directory, с помощью которого Splunk будет считывать данные из концентратора событий</span><span class="sxs-lookup"><span data-stu-id="34cc8-188">Step 4: Register an application with your tenant Azure Active Directory which Splunk will use to read from the event hub</span></span>

<span data-ttu-id="34cc8-189">Для Splunk требуется регистрация приложения в Azure Active Directory вашей организации, чтобы получить нужные разрешения и учетные данные приложения, необходимые для проверки подлинности в концентраторе событий Azure Monitor.</span><span class="sxs-lookup"><span data-stu-id="34cc8-189">Splunk needs an application registration in your organization’s Azure Active Directory to be granted the required permissions and app credentials required to authenticate to the Azure Monitor event hub.</span></span>

1. <span data-ttu-id="34cc8-190">На портале Azure перейдите к разделу **Регистрация приложений** и нажмите **Регистрация нового приложения**.</span><span class="sxs-lookup"><span data-stu-id="34cc8-190">In the Azure portal, go to **App Registrations** and select **New application registration**.</span></span>

    ![Изображение с окном регистрации приложения](images/app-registration.png)

2. <span data-ttu-id="34cc8-192">Укажите имя приложения, а также выберите тип **Веб-приложение / API** и URL-адрес **`https://localhost`** для входа.</span><span class="sxs-lookup"><span data-stu-id="34cc8-192">Select a name for your application, choose **Web app / API** for the type, and **`https://localhost`** for the sign-on URL.</span></span> <span data-ttu-id="34cc8-193">Затем нажмите кнопку **Создать**.</span><span class="sxs-lookup"><span data-stu-id="34cc8-193">Then select **Create**.</span></span>

    ![Конфигурация веб-API](images/app-web-config.png)

3. <span data-ttu-id="34cc8-195">После создания приложения скопируйте **ИД приложения** и сохраните его для последующего использования при настройке каналов входных данных Splunk.</span><span class="sxs-lookup"><span data-stu-id="34cc8-195">After the application is created, copy the **Application ID** and save for later use configuring the Splunk data inputs.</span></span> <span data-ttu-id="34cc8-196">Затем перейдите к параметрам приложения и выберите **Ключи**.</span><span class="sxs-lookup"><span data-stu-id="34cc8-196">Then go to the application settings and choose **Keys**.</span></span>

    ![ИД веб-приложения](images/app-id.png)

    <span data-ttu-id="34cc8-198">Благодаря этому вы сможете создать ключ, называемый секретом приложения.</span><span class="sxs-lookup"><span data-stu-id="34cc8-198">This will allow you to generate a new key, known as an Application Secret.</span></span> <span data-ttu-id="34cc8-199">После его создания скопируйте значение из поля **Секрет приложения** и сохраните его для последующего использования при настройке каналов входных данных Splunk.</span><span class="sxs-lookup"><span data-stu-id="34cc8-199">After it's generated, copy the **Application Secret** and save for later use configuring the Splunk data inputs.</span></span>

4. <span data-ttu-id="34cc8-200">Назначьте приложению роль **Читатель** в подписке Azure, содержащей концентратор событий с оповещениями системы безопасности организации.</span><span class="sxs-lookup"><span data-stu-id="34cc8-200">Grant the application the role of **Reader** in the Azure subscription containing the event hub with your organization’s security alerts.</span></span>

    ![Добавление подписки Azure](images/add-azure-sub.png)

    <span data-ttu-id="34cc8-202">Выберите подписку, а затем выберите **Управление доступом (IAM)**.</span><span class="sxs-lookup"><span data-stu-id="34cc8-202">Select your subscription, choose **Access control (IAM)**.</span></span> <span data-ttu-id="34cc8-203">Нажмите **Добавить**, чтобы добавить разрешения.</span><span class="sxs-lookup"><span data-stu-id="34cc8-203">Select **Add** to add permissions.</span></span> <span data-ttu-id="34cc8-204">Выберите приложение и в поле **Роль** задайте значение **Читатель**.</span><span class="sxs-lookup"><span data-stu-id="34cc8-204">Select your application and choose the **Role** of **Reader** for your application.</span></span>

    ![Добавление разрешений читателя](images/add-reader-perms.png)

    <span data-ttu-id="34cc8-206">Нажмите кнопку **Сохранить**, чтобы добавить в подписку разрешения, предоставленные приложению.</span><span class="sxs-lookup"><span data-stu-id="34cc8-206">Select **Save** to add the permissions granted to your application to the subscription.</span></span>

## <a name="step-5-create-an-azure-key-vault-to-store-the-access-key-for-the-event-hub"></a><span data-ttu-id="34cc8-207">Этап 5. Создание хранилища Azure Key Vault для хранения ключа доступа к концентратору событий</span><span class="sxs-lookup"><span data-stu-id="34cc8-207">Step 5: Create an Azure Key vault to store the access key for the event hub</span></span>

<span data-ttu-id="34cc8-208">Хранилища ключей Azure используются для хранения таких секретов, как удостоверения, пароли и сертификаты для использования приложениями во время их выполнения.</span><span class="sxs-lookup"><span data-stu-id="34cc8-208">Azure key vaults are used to store secrets such as identities, passwords, and certificates for use at runtime by applications.</span></span> <span data-ttu-id="34cc8-209">На этом этапе мы создадим хранилище ключей Azure для хранения секретов, необходимых Splunk для подключения к концентраторам событий Azure, содержащим оповещения системы безопасности организации, и считывания данных.</span><span class="sxs-lookup"><span data-stu-id="34cc8-209">In this step you will create an Azure key vault to store the secrets needed for Splunk to connect and read from the Azure event hubs containing your organization’s security alerts.</span></span>

1. <span data-ttu-id="34cc8-210">На портале Azure перейдите к разделу **Хранилища ключей** и нажмите кнопку **Добавить**.</span><span class="sxs-lookup"><span data-stu-id="34cc8-210">In the Azure portal, go to **Key vaults** and select **Add**.</span></span>

    ![Добавление хранилищ ключей](images/add-key-vaults.png)

2. <span data-ttu-id="34cc8-212">При создании хранилища ключей выберите **Политики доступа**, чтобы добавить политику доступа для приложения, зарегистрированного на этапе 4.</span><span class="sxs-lookup"><span data-stu-id="34cc8-212">When creating the new key vault, select **Access policies** to add a new access policy for the application you just registered in Step 4.</span></span> <span data-ttu-id="34cc8-213">Предоставьте приложению разрешения на **получение** секрета.</span><span class="sxs-lookup"><span data-stu-id="34cc8-213">Grant the **Get** secret permissions to your application.</span></span> <span data-ttu-id="34cc8-214">Благодаря этому Splunk, выступая в качестве зарегистрированного приложения, сможет получать доступ к ключам (секретам) в этом хранилище ключей Azure.</span><span class="sxs-lookup"><span data-stu-id="34cc8-214">This will allow Splunk, acting as the registered application, to access the keys (secrets) stored in this Azure key vault.</span></span>

    ![Добавление политик доступа](images/add-access-policies.png)

    <span data-ttu-id="34cc8-216">Нажмите кнопку **Создать**, чтобы завершить создание хранилища ключей Azure.</span><span class="sxs-lookup"><span data-stu-id="34cc8-216">Select **Create** to complete the creation of your new Azure key vault.</span></span>

3. <span data-ttu-id="34cc8-217">Создайте в хранилище ключей секрет для хранения ключа доступа к пространству имен концентраторов событий.</span><span class="sxs-lookup"><span data-stu-id="34cc8-217">Generate a new secret in your key vault to store the access key to your event hub namespace.</span></span> <span data-ttu-id="34cc8-218">Для начала получите ключ доступа к пространству имен концентраторов событий, открыв это пространство имен и выбрав **Политики общего доступа**.</span><span class="sxs-lookup"><span data-stu-id="34cc8-218">First, grab the access key to your event hub namespace by opening your event hub namespace and selecting **Shared access policies**.</span></span> <span data-ttu-id="34cc8-219">Выберите политику **RootManageSharedAccessKey** из списка и скопируйте **первичный ключ**.</span><span class="sxs-lookup"><span data-stu-id="34cc8-219">Select the **RootManageSharedAccessKey** policy from the list and copy the **Primary Key** from the list.</span></span>

    ![Получение политик общего доступа](images/get-shared-policies.png)

4. <span data-ttu-id="34cc8-221">Откройте хранилище ключей и выберите **Секреты**.</span><span class="sxs-lookup"><span data-stu-id="34cc8-221">Open your key vault and select **Secrets**.</span></span> <span data-ttu-id="34cc8-222">Нажмите **Создать/импортировать**, чтобы добавить секрет в хранилище ключей.</span><span class="sxs-lookup"><span data-stu-id="34cc8-222">Choose **Generate/Import** to add a new secret to the key vault.</span></span> <span data-ttu-id="34cc8-223">Вставьте **первичный ключ** из пространства имен для концентраторов событий **RootManageSharedAccessKey**.</span><span class="sxs-lookup"><span data-stu-id="34cc8-223">Paste in the **Primary key** from the event hub namespace **RootManageSharedAccessKey**.</span></span>

    ![Создание секрета](images/generate-new-secret.png)

5. <span data-ttu-id="34cc8-225">После его создания выберите клиент и скопируйте значение из поля **Версия секрета**.</span><span class="sxs-lookup"><span data-stu-id="34cc8-225">After it's created, select the secret and copy the **Secret Version** of the secret.</span></span> <span data-ttu-id="34cc8-226">Он будет использоваться на этапе 6 для настройки каналов входных данных Splunk.</span><span class="sxs-lookup"><span data-stu-id="34cc8-226">This will be used later in Step 6 to configure Splunk data inputs.</span></span>

    ![Версия секрета](images/secret-version.png)

## <a name="step-6-configure-the-splunk-data-inputs-to-consume-security-alerts-stored-in-the-event-hub"></a><span data-ttu-id="34cc8-228">Этап 6. Настройка каналов входных данных Splunk на получение оповещений системы безопасности, хранящихся в концентраторе событий</span><span class="sxs-lookup"><span data-stu-id="34cc8-228">Step 6: Configure the Splunk data inputs to consume security alerts stored in the event hub</span></span>

<span data-ttu-id="34cc8-229">Последний этап — настройка каналов входных данных Splunk на использование концентратора событий, приложения и секретов, созданных на предыдущих этапах.</span><span class="sxs-lookup"><span data-stu-id="34cc8-229">The last step to complete the setup process is to configure Splunk data inputs to utilize the event hub, application, and secrets you created in previous steps.</span></span>

1. <span data-ttu-id="34cc8-230">Следуйте инструкциям из статьи [Настройка Splunk](https://github.com/Microsoft/AzureMonitorAddonForSplunk/wiki/Configuration-of-Splunk), чтобы открыть и настроить каналы входных данных Splunk для надстройки Azure Monitor.</span><span class="sxs-lookup"><span data-stu-id="34cc8-230">Follow the instructions in the [Configuration of Splunk](https://github.com/Microsoft/AzureMonitorAddonForSplunk/wiki/Configuration-of-Splunk) topic to open and configure Splunk data inputs for the Azure Monitor Add-on.</span></span> <span data-ttu-id="34cc8-231">Перейдите к разделу **Параметры** и выберите **Входные данные**.</span><span class="sxs-lookup"><span data-stu-id="34cc8-231">Go to **Settings** and **Data Inputs**.</span></span> <span data-ttu-id="34cc8-232">Выберите **Журналы диагностики Azure Monitor**.</span><span class="sxs-lookup"><span data-stu-id="34cc8-232">Choose **Azure Monitor Diagnostic Logs**.</span></span>
2. <span data-ttu-id="34cc8-233">Нажмите кнопку **Создать** и заполните все обязательные поля, используя значения, собранные на предыдущих этапах.</span><span class="sxs-lookup"><span data-stu-id="34cc8-233">Select **New** and input all the required fields using the values obtained in the previous steps.</span></span> <span data-ttu-id="34cc8-234">На приведенном ниже изображении показаны все обязательные поля со значениями из предыдущих примеров в этой статье.</span><span class="sxs-lookup"><span data-stu-id="34cc8-234">The following image shows all the required fields using the values from the previous examples in this article.</span></span>

    ![Поля Azure Monitor](images/azure-monitor-fields.png)

3. <span data-ttu-id="34cc8-236">Нажмите кнопку **Далее** и приступите к поиску оповещений от системы безопасности организации, полученных из Azure Monitor.</span><span class="sxs-lookup"><span data-stu-id="34cc8-236">Select **Next** and begin searching your organization’s security alerts ingested from Azure Monitor.</span></span>

## <a name="optional-use-splunk-search-to-explore-data"></a><span data-ttu-id="34cc8-237">(Необязательно) Использование поиска Splunk для просмотра данных</span><span class="sxs-lookup"><span data-stu-id="34cc8-237">(Optional) Use Splunk Search to explore data</span></span>

<span data-ttu-id="34cc8-238">После настройки подключаемого модуля Splunk в Azure Monitor экземпляр Splunk начнет получать события из настроенного концентратора событий.</span><span class="sxs-lookup"><span data-stu-id="34cc8-238">After you have set up the Azure Monitor Splunk plugin, your Splunk instance will start retrieving events from the configured event hub.</span></span> <span data-ttu-id="34cc8-239">По умолчанию Splunk будет индексировать каждое свойство схемы оповещения API безопасности Microsoft Graph, чтобы разрешить поиск.</span><span class="sxs-lookup"><span data-stu-id="34cc8-239">By default, Splunk will index each property of the Microsoft Graph Security API alert schema to allow searching.</span></span>

<span data-ttu-id="34cc8-240">Чтобы искать оповещения API безопасности Microsoft Graph, создавать информационные панели или настраивать оповещения Splunk с помощью поискового запроса, перейдите в приложения -> "Приложение для поиска и создания отчетов в Splunk"</span><span class="sxs-lookup"><span data-stu-id="34cc8-240">To search for Microsoft Graph Security API alerts, to create dashboards, or to set Splunk alerts with your search query, navigate to apps -> Search & Reporting app in Splunk.</span></span>

<span data-ttu-id="34cc8-241">**Примеры:**</span><span class="sxs-lookup"><span data-stu-id="34cc8-241">Examples</span></span><br/>
<span data-ttu-id="34cc8-242">Попытка поиска оповещений безопасности Graph:</span><span class="sxs-lookup"><span data-stu-id="34cc8-242">Try searching Graph Security alerts:</span></span>

- <span data-ttu-id="34cc8-243">Введите `sourcetype="amdl:securitygraph:alert"` в строке поиска, чтобы получить все оповещения, выполненные с помощью API безопасности Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="34cc8-243">Type `sourcetype="amdl:securitygraph:alert"` in the search bar to get all alerts surfaced through the Microsoft Graph Security API.</span></span> <span data-ttu-id="34cc8-244">Справа отобразятся свойства верхнего уровня журнала Azure Monitor, где оповещения системы безопасности Graph находятся под полем свойств.</span><span class="sxs-lookup"><span data-stu-id="34cc8-244">On the right-hand side, you will see the top-level properties of Azure Monitor log where Graph Security alert is under properties field.</span></span><br/>
- <span data-ttu-id="34cc8-245">В левой области отобразятся выбранные и интересные поля.</span><span class="sxs-lookup"><span data-stu-id="34cc8-245">On the left pane, you will see selected fields and interesting fields.</span></span> <span data-ttu-id="34cc8-246">Выбранные поля можно использовать для создания информационных панелей или оповещений Splunk. Вы можете также добавить или удалить выбранные поля, щелкнув по ним правой кнопкой мыши.</span><span class="sxs-lookup"><span data-stu-id="34cc8-246">You can use selected fields to create dashboards or Splunk alerts, you can also add or remove selected fields by right-clicking on the fields.</span></span>  
> <span data-ttu-id="34cc8-247">**Примечание.** Как показано в приведенном ниже поисковом запросе, можно ограничить поиск при необходимости.</span><span class="sxs-lookup"><span data-stu-id="34cc8-247">**Note:** As shown in the following search query, you can restrict your search as needed.</span></span> <span data-ttu-id="34cc8-248">В этом примере применяется фильтрация оповещений системы безопасности Graph по оповещениям с высоким уровнем серьезности от центра безопасности Azure.</span><span class="sxs-lookup"><span data-stu-id="34cc8-248">In the example, we filter the Graph Security Alerts by high severity alerts from Azure Security Center.</span></span> <span data-ttu-id="34cc8-249">Также использованы аргументы `eventDatetime`, `severity`, `status` и `provider` в качестве отображаемых выбранных полей.</span><span class="sxs-lookup"><span data-stu-id="34cc8-249">We also used `eventDatetime`, `severity`, `status`, and `provider` as selected fields to be displayed.</span></span> <span data-ttu-id="34cc8-250">Расширенные условия поиска см. в статье [Руководства по поиску в Splunk](https://docs.splunk.com/Documentation/Splunk/7.1.2/SearchTutorial/WelcometotheSearchTutorial).</span><span class="sxs-lookup"><span data-stu-id="34cc8-250">For more advance search terms, see [Splunk search tutorials](https://docs.splunk.com/Documentation/Splunk/7.1.2/SearchTutorial/WelcometotheSearchTutorial).</span></span>

 ![splunk_search_query](images/splunk-search-query.png)
> <span data-ttu-id="34cc8-252">Поисковый запрос: `sourcetype="amdl:securitygraph:alert" "properties.vendorInformation.provider"=ASC "properties.severity"=High | rename properties.eventDataTime as eventDateTime properties.severity as severity properties.vendorInformation.provider as provider properties.status as status`</span><span class="sxs-lookup"><span data-stu-id="34cc8-252">`sourcetype="amdl:securitygraph:alert" "properties.vendorInformation.provider"=ASC "properties.severity"=High | rename properties.eventDataTime as eventDateTime properties.severity as severity properties.vendorInformation.provider as provider properties.status as status`</span></span>

<span data-ttu-id="34cc8-253">Splunk также позволяет выполнять различные действия с результатами поиска с помощью параметра меню "Сохранить как" в правом верхнем углу экрана.</span><span class="sxs-lookup"><span data-stu-id="34cc8-253">Splunk also allows multiple actions on search results using the "Save As" menu option in top right of the screen.</span></span> <span data-ttu-id="34cc8-254">Можно создавать отчеты, информационные панели или оповещения с учетом фильтра поиска.</span><span class="sxs-lookup"><span data-stu-id="34cc8-254">You can create Reports, Dashboard Panels, or Alerts based on your search filter.</span></span>
<span data-ttu-id="34cc8-255">Ниже приведен пример информационной панели мониторинга с потоком событий на основе предыдущего запроса: вы можете добавить детализирующую ссылку в каждое событие для дальнейшего доступа к сведениям на сайте Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="34cc8-255">Below is an example of a dashboard with an event stream based on the previous query: You can add a drilldown link to each event to further access the details on Microsoft Graph site.</span></span> <span data-ttu-id="34cc8-256">См. статью [Детализирующая документация Splunk](https://docs.splunk.com/Documentation/Splunk/7.1.2/Viz/DrilldownIntro).</span><span class="sxs-lookup"><span data-stu-id="34cc8-256">See [Splunk drilldown documentation](https://docs.splunk.com/Documentation/Splunk/7.1.2/Viz/DrilldownIntro).</span></span>

 ![splunk_search_results](images/splunk-search-results.png)

<span data-ttu-id="34cc8-258">Или можно создать информационную панель в виде временной шкалы:</span><span class="sxs-lookup"><span data-stu-id="34cc8-258">Or you can create a dashboard as a timeline chart:</span></span>

 ![splunk_search_timeline](images/splunk-search-timeline.png)

<span data-ttu-id="34cc8-260">Дополнительные сведения см. в [руководстве по поиску и созданию отчетов в Splunk](https://docs.splunk.com/Documentation/Splunk/7.1.2/SearchTutorial/WelcometotheSearchTutorial).</span><span class="sxs-lookup"><span data-stu-id="34cc8-260">You can follow [Splunk Search & Report tutorial](https://docs.splunk.com/Documentation/Splunk/7.1.2/SearchTutorial/WelcometotheSearchTutorial) for more details.</span></span>

