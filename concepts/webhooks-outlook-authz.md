---
title: Сокращение количества отсутствующих подписок и уведомлений об изменениях для ресурсов Outlook (Предварительная версия)
description: Outlook может приостановить доставку уведомлений об изменениях из-за событий безопасности, например сброса пароля пользователя. Особые события жизненного цикла, которые необходимо `subscriptionRemoved` `missed` обработать для обеспечения непрерывной доставки уведомлений об изменениях.
author: baywet
localization_priority: Priority
ms.custom: graphiamtop20
ms.openlocfilehash: 8b2174ea14dd7e3d6af7f0b4a447c4e5afa6fce1
ms.sourcegitcommit: 4fa554d92a684d7720db1bd96befb9dea8d6ba5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/30/2020
ms.locfileid: "44429630"
---
# <a name="reduce-missing-subscriptions-and-change-notifications-for-outlook-resources-preview"></a>Сокращение количества отсутствующих подписок и уведомлений об изменениях для ресурсов Outlook (Предварительная версия) 

Подписки на приложения на уведомления об изменениях для ресурсов Outlook могут стать удаленными и пропускать некоторые уведомления об изменениях. Приложения должны реализовать логику для обнаружения и восстановления после потери и возобновление непрерывного процесса уведомления об изменении.

Некоторые события в Outlook могут приводить к удалению подписки. К таким событиям относятся:

- сброс пароля пользователя;
- устройство пользователя не соответствует требованиям;
-   учетная запись пользователя отозвана.

В случае такого события Outlook отправляет специальное уведомление жизненного цикла `subscriptionRemoved`.

Outlook также отправляет еще одно уведомление о жизненном цикле, `missed` Если уведомление об изменении не может быть доставлено приложению.

Приложение, которое поддается подписке на уведомления об изменениях для ресурсов Outlook, таких как **сообщение** и **событие**, должно прослушивать `subscriptionRemoved` `missed` сигналы и выполнять следующие действия:

- После получения `subscriptionRemoved` уведомления жизненного цикла приложение должно повторно создать подписку, чтобы обеспечить непрерывный процесс.
- При получении `missed` уведомления о жизненном цикле приложение должно повторно синхронизировать данные ресурса с помощью Microsoft Graph.

Чтобы получать уведомления о жизненном цикле, вы можете использовать существующую конечную точку **notificationUrl** , которая уже получает уведомления об изменениях, или зарегистрировать отдельные **лифецикленотификатионурл** для получения `subscriptionRemoved` уведомлений и их `missed` жизненного цикла в отдельной конечной точке.

## <a name="creating-a-subscription"></a>Создание подписки

При создании подписки можно указать отдельную конечную точку с помощью свойства **лифецикленотификатионурл** . Если указана конечная точка, все текущие и будущие типы уведомлений жизненного цикла будут доставляться в нее. В противном случае, `subscriptionRemoved` и `missed` уведомления о жизненных циклах будут доставляться в существующие **notificationUrl** для всех существующих подписок.

> **Примечание.** Свойство **lifecycleNotificationUrl** можно настроить или считать только с помощью интерфейсов API Microsoft Graph. Однако подписки, созданные с помощью бета-версий API, хранятся в той же рабочей среде, что и подписки, созданные с помощью версии 1.0, поэтому можно реализовать новый поток Outlook в дополнение к вашим подпискам, создаваемым с помощью версии API 1.0.

> Подписки, созданные с помощью версии API 1.0, будут получать уведомления жизненного цикла. 

### <a name="subscription-request-example"></a>Пример запроса на подписку

```http
POST https://graph.microsoft.com/beta/subscriptions
Content-Type: application/json
{
  "changeType": "created,updated",
  "notificationUrl": "https://webhook.azurewebsites.net/api/resourceNotifications",
  "lifecycleNotificationUrl": "https://webhook.azurewebsites.net/api/lifecycleNotifications",
  "resource": "/users/{id}/messages",
  "expirationDateTime": "2019-03-20T11:00:00.0000000Z",
  "clientState": "<secretClientState>"
}
```
 
> **Важно!** Используйте одинаковое имя узла для обоих URL-адресов уведомлений. 

> **Примечание:** Необходимо проверить обе конечные точки, как описано в статье [Управление подписками](webhooks.md#managing-subscriptions).
Если вы решили использовать один URL-адрес для обеих конечных точек, вы получите два запроса на проверку с необходимостью ответа на них.

> **Примечание.** Вы не сможете обновить (`PATCH`) существующие подписки, чтобы добавить свойство **lifecycleNotificationUrl**. Следует удалить такие существующие подписки, создать новые подписки и указать свойство **lifecycleNotificationUrl**. Существующие подписки без свойства **лифецикленотификатионурл** будут получать `subscriptionRemoved` `missed` уведомления о жизненном цикле через **notificationUrl**. 

## <a name="responding-to-subscriptionremoved-notifications"></a>Ответ на уведомления subscriptionRemoved

`subscriptionRemoved`Уведомление о жизненном цикле уведомляет о том, что подписка удалена и должна быть повторно создана, если вы хотите продолжить получать уведомления об изменениях. 

Вы можете создать подписку с длинным сроком действия (3 дня), а уведомления об изменениях начнут переступать в **notificationUrl**. Однако условия доступа к данным ресурса могут со временем измениться. Например, в службе Outlook может произойти событие, требующее от приложения повторной проверки подлинности пользователя. В таком случае поток выглядит следующим образом:

1. Outlook определяет, что подписка должна быть удалена из Microsoft Graph.
    
    Для этих событий отсутствует заданная периодичность. Для одних ресурсов они могут происходить часто, а для других — практически никогда.

2. Microsoft Graph отправляет `subscriptionRemoved` уведомление о жизненном цикле в **лифецикленотификатионурл** (если оно указано) или **notificationUrl**.  

3. Вы можете ответить на это уведомление о жизненном цикле, создав новую подписку для того же ресурса. Для этого нужно представить допустимый маркер доступа; в некоторых случаях это означает, что приложению необходимо выполнить повторную проверку подлинности пользователя, чтобы получить новый допустимый маркер доступа.

4. Если вы успешно создали новую подписку, уведомления об изменениях начнут переступать повторно. Однако в случае ошибки (например, приложению не удается получить действительный маркер доступа) уведомления об изменениях не будут отправлены.

5. Создав новую подписку, вы можете синхронизировать данные ресурсов, чтобы выявить все отсутствующие изменения.

### <a name="subscriptionremoved-notification-example"></a>Пример уведомления subscriptionRemoved

```json
{
  "value": [
    {
      "subscriptionId":"<subscription_guid>",
      "subscriptionExpirationDateTime":"2019-03-20T11:00:00.0000000Z",
      "tenantId": "<tenant_guid>",
      "clientState":"<secretClientState>",
      "lifecycleEvent": "subscriptionRemoved"
    }
  ]
}
```

Обратите внимание на следующие моменты для этого типа уведомления.
- Поле `"lifecycleEvent": "subscriptionRemoved"` определяет это уведомление, как связанное с удалением подписки. Также возможны другие типы уведомлений жизненного цикла. В будущем будут добавлены новые типы.
- В уведомлении о жизненном цикле не содержатся сведения об определенном ресурсе, так как он не связан с изменением ресурса, но с изменением состояния подписки.
- Аналогично уведомлениям об изменении, уведомления о жизненном цикле могут составляться пакетно (в массиве **значений** ), с которым, возможно, различное значение **лифецикливент** . Соответствующим образом обработайте каждое уведомление о жизненном цикле в пакете.

> **Примечание:** полное описание данных, отправленных при доставке уведомлений об изменении, приведено в разделе [чанженотификатионколлектион](/graph/api/resources/changenotificationcollection).

### <a name="actions-to-take"></a>Выполняемые действия

1. [Подтвердите](webhooks.md#change-notifications) получение уведомления о жизненном цикле, выполнив ответ на вызов Post `202 - Accepted` .
2. [Проверка](webhooks.md#change-notifications) подлинности уведомления о жизненном цикле.
3. Убедитесь, что у приложения есть допустимый маркер доступа для выполнения следующего действия. 
  > **Примечание.** Если вы используете одну из [библиотек проверки подлинности](https://docs.microsoft.com/azure/active-directory/develop/reference-v2-libraries), они сделают это за вас, повторно использовав допустимый кэшированный маркер или получив новый маркер, а также попросив пользователя войти еще раз (с помощью нового пароля). Обратите внимание, что получение нового маркера может завершиться сбоем, так как условия доступа могли измениться, и вызывающей стороне больше недоступны данные ресурсов.

4. Создайте новую подписку с помощью стандартного процесса, описанного [здесь](webhooks.md#subscription-request-example).

  > **Примечание.** Это действие может завершиться сбоем, так как проверки авторизации, выполняемые системой, могут отказать приложению или пользователю в доступе к ресурсу. Приложению может потребоваться получение нового маркера доступа от пользователя для повторной авторизации подписки. Вы можете повторить эти действия позднее в любое время, например, когда изменятся условия доступа. Любые изменения ресурсов за период времени с момента отправки уведомления о жизненном цикле, чтобы приложение успешно повторно создало подписку, будет потеряно. Приложению потребуется получить эти изменения самостоятельно.

5. После создания новой подписки синхронизируйте все недостающие данные ресурсов из последнего известного времени, когда вы получили уведомление об изменении этого ресурса; Например:`GET https://graph.microsoft.com/v1.0/users/{id}/messages?$filter=createdDateTime+ge+{LastTimeNotificationWasReceived}`

## <a name="responding-to-missed-notifications"></a>Реагирование на пропущенные уведомления

Эти сигналы сообщают о том, что некоторые уведомления об изменениях могут быть не доставлены. Вам следует решить, пропустить или обработать эти сигналы.

### <a name="notification-example"></a>Пример уведомления

```json
{
  "value": [
    {
      "subscriptionId":"<subscription_guid>",
      "subscriptionExpirationDateTime":"2019-03-20T11:00:00.0000000Z",
      "tenantId": "<tenant_guid>",
      "clientState":"<secretClientState>",
      "lifecycleEvent": "missed"
    }
  ]
}
```

Обратите внимание на следующие моменты для этого типа уведомления.
- `"lifecycleEvent": "missed"`Это поле указывает на сигнал о пропущенных уведомлениях об изменении. Также возможны другие типы уведомлений жизненного цикла. В будущем будут добавлены новые типы.
- В уведомлении о жизненном цикле не содержатся сведения об определенном ресурсе, так как он не связан с изменением ресурса, но с изменением состояния подписки.
- Как и в случае с уведомлениями об изменении, уведомления жизненного цикла могут объединяться в пакет (в массиве **значений** ) с разными значениями **лифецикливент** . Соответствующим образом обработайте каждое уведомление о жизненном цикле в пакете.

> **Примечание:** полное описание данных, отправленных при доставке уведомлений об изменении, приведено в разделе [чанженотификатионколлектион](/graph/api/resources/changenotificationcollection).

### <a name="actions-to-take"></a>Выполняемые действия

1. [Подтвердите](webhooks.md#change-notifications) получение уведомления о жизненном цикле, выполнив ответ на вызов Post `202 - Accepted` .
    - Если вы игнорируете эти сигналы, не выполняйте других действий. В противном случае:
2. [Проверка](webhooks.md#change-notifications) подлинности уведомления о жизненном цикле.
3. Выполните полную повторную синхронизацию данных ресурса для выявления изменений, не доставленных в качестве уведомлений. 


## <a name="future-proof-the-code-handling-lifecycle-notifications"></a>Готовый к изменениям код обработки уведомлений жизненного цикла

В будущем Microsoft Graph добавит дополнительные типы уведомлений о жизненном цикле подписки. Они будут публиковаться в той же конечной точке: **lifecycleNotificationUrl**, но у них будет другое значение для **lifecycleEvent**, и они могут содержать немного другую схему и свойства, относящиеся к сценарию, для которого они создаются.

Следует реализовать свой код с готовностью к будущим изменениям, чтобы он не прерывался, когда в Microsoft Graph вводятся новые типы уведомлений жизненного цикла. Мы рекомендуем следующий подход:

1. Явно определите каждое уведомление о жизненном цикле в качестве события, которое поддерживается, с помощью свойства **лифецикливент** . Например, найдите свойство `"lifecycleEvent": "subscriptionRemoved"` для определения конкретного события и обработайте его.

2. Просмотрите объявления уведомлений о жизненном цикле для новых сценарионс. В будущем может быть несколько типов уведомлений о жизненном цикле.

3. В приложении игнорируйте все уведомления о жизненном цикле, которые приложение не распознает, и заносить их в журнал для получения сведений о состоянии.

4. По своему усмотрению просматривайте соответствующую документацию о новых уведомлениях жизненного цикла и реализуйте для них нужную поддержку.

## <a name="see-also"></a>См. также

- [Тип ресурса subscription](/graph/api/resources/subscription?view=graph-rest-1.0)
- [Получение подписки](/graph/api/subscription-get?view=graph-rest-1.0)
- [Создание подписки](/graph/api/subscription-post-subscriptions?view=graph-rest-1.0)
- [Удаление подписки](/graph/api/subscription-delete?view=graph-rest-1.0)
- [Обновление подписки](/graph/api/subscription-update?view=graph-rest-1.0)
