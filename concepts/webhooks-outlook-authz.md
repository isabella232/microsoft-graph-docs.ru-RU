---
title: Уменьшение числа пропущенных подписок и уведомлений о ресурсах Outlook (предварительная версия)
description: Outlook может приостановить доставку уведомлений об изменениях из-за событий безопасности, например сброса пароля пользователя. Для обеспечения непрерывной доставки уведомлений необходимо обрабатывать специальные события жизненного цикла (`subscriptionRemoved` и `missed`).
author: piotrci
localization_priority: Priority
ms.openlocfilehash: 7f273046c084e83375c835349b43caebcefca473
ms.sourcegitcommit: 9cee9d8229fc84dd7ef97670ff27c145e1a78408
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/18/2019
ms.locfileid: "35778245"
---
# <a name="reduce-missing-subscriptions-and-notifications-for-outlook-resources-preview"></a>Уменьшение числа пропущенных подписок и уведомлений о ресурсах Outlook (предварительная версия) 

У приложений, подписывающихся на уведомления о ресурсах Outlook, могут быть удалены их подписки, что приводит к пропуску некоторых уведомлений. В приложениях должна быть реализована логика определения потерь и восстановления после них, а также возобновления непрерывного потока уведомлений.

Некоторые события в Outlook могут приводить к удалению подписки. К таким событиям относятся:

- сброс пароля пользователя;
- устройство пользователя не соответствует требованиям;
-   учетная запись пользователя отозвана.

В случае такого события Outlook отправляет специальное уведомление жизненного цикла `subscriptionRemoved`.

Outlook также отправляет другое уведомление жизненного цикла `missed`, если уведомление не может быть доставлено в приложение.

Приложение, подписывающееся на уведомления о ресурсах Outlook, таких как **message** и **event**, должно прослушивать сигналы `subscriptionRemoved` и `missed`:

- После получения уведомления `subscriptionRemoved` приложение должно повторно создать подписку, чтобы поддерживать непрерывный поток.
- При получении уведомления `missed` приложение должно повторно синхронизировать данные ресурсов с помощью Microsoft Graph.

Чтобы получать уведомления жизненного цикла, можно использовать существующую конечную точку **notificationUrl**, которая уже получает уведомления о ресурсе, или можно зарегистрировать отдельное свойство **lifecycleNotificationUrl** для получения уведомлений `subscriptionRemoved` и `missed` в отдельной конечной точке.

## <a name="creating-a-subscription"></a>Создание подписки

При создании подписки вы можете указать отдельную конечную точку уведомлений с помощью свойства **lifecycleNotificationUrl**. Если указана конечная точка, все текущие и будущие типы уведомлений жизненного цикла будут доставляться в нее. В противном случае уведомления `subscriptionRemoved` и `missed` будут доставляться в существующую конечную точку **notificationUrl** для всех существующих подписок.

> **Примечание.** В настоящий момент свойство **lifecycleNotificationUrl** можно настроить или считать только с помощью версии `beta` интерфейсов API Microsoft Graph. Однако подписки, созданные с помощью версии `beta`, хранятся в той же рабочей среде, что и для версии `v1.0`, поэтому можно реализовать новый поток Outlook, описанный в этой статье, в дополнение к обычному использованию версии `v1.0` с другими подписками.

### <a name="subscription-request-example"></a>Пример запроса на подписку

```http
POST https://graph.microsoft.com/beta/subscriptions
Content-Type: application/json
{
  "changeType": "created,updated",
  "notificationUrl": "https://webhook.azurewebsites.net/api/resourceNotifications",
  "lifecycleNotificationUrl": "https://webhook.azurewebsites.net/api/lifecycleNotifications",
  "resource": "/users/{id}/messages",
  "expirationDateTime": "2019-03-20T11:00:00.0000000Z",
  "clientState": "<secretClientState>"
}
```
 
> **Важно!** Используйте одинаковое имя узла для обоих URL-адресов уведомлений. 

> **Примечание.** Вам нужно проверить обе конечные точки уведомлений, как описано в [статье об универсальных уведомлениях](webhooks.md#managing-subscriptions).
Если вы решили использовать один URL-адрес для обеих конечных точек, вы получите два запроса на проверку с необходимостью ответа на них.

> **Примечание.** Вы не сможете обновить (`PATCH`) существующие подписки, чтобы добавить свойство **lifecycleNotificationUrl**. Следует удалить такие существующие подписки, создать новые подписки и указать свойство **lifecycleNotificationUrl**. Существующие подписки без свойства **lifecycleNotificationUrl** получают уведомления `subscriptionRemoved` и `missed` через **notificationUrl**. 

## <a name="responding-to-subscriptionremoved-notifications"></a>Ответ на уведомления subscriptionRemoved

Уведомление `subscriptionRemoved` информирует, что подписка была удалена и следует создать ее заново, если вы хотите продолжать получение уведомлений. 

Вы можете создавать длительные подписки (например, на 3 дня), а уведомления о данных ресурса начнут поступать в **notificationUrl**. Однако условия доступа к данным ресурса могут со временем измениться. Например, в службе Outlook может произойти событие, требующее от приложения повторной проверки подлинности пользователя. В таком случае поток выглядит следующим образом:

1. Outlook определяет, что подписка должна быть удалена из Microsoft Graph.
    1. Для этих событий отсутствует заданная периодичность. Для одних ресурсов они могут происходит часто, а для других — практически никогда.

2. Microsoft Graph отправляет уведомление `subscriptionRemoved` для **lifecycleNotificationUrl** (если указано) или **notificationUrl**.  

3. Вы можете ответить на это уведомление, создав новую подписку для того же ресурса. Для этого нужно представить допустимый маркер доступа; в некоторых случаях это означает, что приложению необходимо выполнить повторную проверку подлинности пользователя, чтобы получить новый допустимый маркер доступа.

4. Если вы успешно создали новую подписку, возобновится поток уведомлений о ресурсах. Но если вам не удалось это сделать (например, приложение не смогло получить допустимый маркер доступа), уведомления о ресурсах не отправляются.

5. Создав новую подписку, вы можете синхронизировать данные ресурсов, чтобы выявить все отсутствующие изменения.

### <a name="subscriptionremoved-notification-example"></a>Пример уведомления subscriptionRemoved

```json
{
  "value": [
    {
      "subscriptionId":"<subscription_guid>",
      "subscriptionExpirationDateTime":"2019-03-20T11:00:00.0000000Z",
      "tenantId": "<tenant_guid>",
      "clientState":"<secretClientState>",
      "lifecycleEvent": "subscriptionRemoved"
    }
  ]
}
```

Обратите внимание на следующие моменты для этого типа уведомления.
- Поле `"lifecycleEvent": "subscriptionRemoved"` определяет это уведомление, как связанное с удалением подписки. Также возможны другие типы уведомлений жизненного цикла. В будущем будут добавлены новые типы.
- Это уведомление не содержит никаких сведений о конкретном ресурсе, так как оно связано не с изменением ресурса, а с изменением состояния подписки.
- Как и уведомления о ресурсах, уведомления жизненного цикла могут объединяться (в массиве **value**), каждое с возможно разными значениями **lifecycleEvent**. Обрабатывайте каждое уведомление в пакете соответствующим образом.

### <a name="actions-to-take"></a>Выполняемые действия

1. [Подтвердите](webhooks.md#notifications) получение уведомления, ответив на вызов POST с помощью `202 - Accepted`.
2. [Проверьте](webhooks.md#notifications) подлинность уведомления.
3. Убедитесь, что у приложения есть допустимый маркер доступа для выполнения следующего действия. 
> **Примечание.** Если вы используете одну из [библиотек проверки подлинности](https://docs.microsoft.com/azure/active-directory/develop/reference-v2-libraries), они сделают это за вас, повторно использовав допустимый кэшированный маркер или получив новый маркер, а также попросив пользователя войти еще раз (например, с помощью нового пароля). Обратите внимание, что получение нового маркера может завершиться сбоем, так как условия доступа могли измениться, и вызывающей стороне больше недоступны данные ресурсов.

4. Создайте новую подписку с помощью стандартного процесса, описанного [здесь](webhooks.md#subscription-request-example).

> **Примечание.** Это действие может завершиться сбоем, так как проверки авторизации, выполняемые системой, могут отказать приложению или пользователю в доступе к ресурсу. Приложению может потребоваться получение нового маркера доступа от пользователя для повторной авторизации подписки. Вы может повторить эти действия позднее в любое время, например, когда изменятся условия доступа. Все изменения ресурсов с момента отправки уведомления жизненного цикла до успешного воссоздания подписки приложением будут потеряны. Приложению потребуется получить эти изменения самостоятельно.

5. После создания новой подписки синхронизируйте все отсутствующие данные ресурсов с последнего известного момента получения уведомления об этом ресурсе. Например: `GET https://graph.microsoft.com/v1.0/users/{id}/messages?$filter=createdDateTime+ge+{LastTimeNotificationWasReceived}`

## <a name="responding-to-missed-notifications"></a>Реагирование на пропущенные уведомления

Эти сигналы сообщают, что некоторые уведомления могли быть не доставлены. Вам следует решить, пропустить или обработать эти сигналы.

### <a name="notification-example"></a>Пример уведомления

```json
{
  "value": [
    {
      "subscriptionId":"<subscription_guid>",
      "subscriptionExpirationDateTime":"2019-03-20T11:00:00.0000000Z",
      "tenantId": "<tenant_guid>",
      "clientState":"<secretClientState>",
      "lifecycleEvent": "missed"
    }
  ]
}
```

Обратите внимание на следующие моменты для этого типа уведомления.
- Поле `"lifecycleEvent": "missed"` определяет это в качестве сигнала о пропущенных уведомлениях. Также возможны другие типы уведомлений жизненного цикла. В будущем будут добавлены новые типы.
- Это уведомление не содержит никаких сведений о конкретном ресурсе, так как оно связано не с изменением ресурса, а с изменением состояния подписки.
- Как и уведомления о ресурсах, уведомления жизненного цикла могут объединяться (в массиве **value**), каждое с возможно разными значениями **lifecycleEvent**. Обрабатывайте каждое уведомление в пакете соответствующим образом.

### <a name="actions-to-take"></a>Выполняемые действия

1. [Подтвердите](webhooks.md#notifications) получение уведомления, ответив на вызов POST с помощью `202 - Accepted`.
    - Если вы игнорируете эти сигналы, не выполняйте других действий. В противном случае:
2. [Проверьте](webhooks.md#notifications) подлинность уведомления.
3. Выполните полную повторную синхронизацию данных ресурса для выявления изменений, не доставленных в качестве уведомлений. 


## <a name="future-proof-the-code-handling-lifecycle-notifications"></a>Готовый к изменениям код обработки уведомлений жизненного цикла

В будущем в Microsoft Graph будут добавлены другие типы уведомлений жизненного цикла подписки. Они будут публиковаться в той же конечной точке: **lifecycleNotificationUrl**, но у них будет другое значение для **lifecycleEvent**, и они могут содержать немного другую схему и свойства, относящиеся к сценарию, для которого они создаются.

Следует реализовать свой код с готовностью к будущим изменениям, чтобы он не прерывался, когда в Microsoft Graph вводятся новые типы уведомлений жизненного цикла. Мы рекомендуем следующий подход:

1. Явным образом определите каждое уведомление как поддерживаемое событие с помощью свойства **lifecycleEvent**. Например, найдите свойство `"lifecycleEvent": "subscriptionRemoved"` для определения конкретного события и обработайте его.

2. Просматривайте объявления об уведомлениях для новых сценариев, так как в будущем могут быть представлены дополнительные типы уведомлений жизненного цикла.

3. В своем приложении игнорируйте любые события жизненного цикла, не распознаваемые приложением, и заносите их в журнал для ознакомления.

4. По своему усмотрению просматривайте соответствующую документацию о новых уведомлениях жизненного цикла и реализуйте для них нужную поддержку.

## <a name="see-also"></a>См. также

- [Тип ресурса subscription](/graph/api/resources/subscription?view=graph-rest-1.0)
- [Получение подписки](/graph/api/subscription-get?view=graph-rest-1.0)
- [Создание подписки](/graph/api/subscription-post-subscriptions?view=graph-rest-1.0)
- [Удаление подписки](/graph/api/subscription-delete?view=graph-rest-1.0)
- [Обновление подписки](/graph/api/subscription-update?view=graph-rest-1.0)
