---
title: Настройка уведомлений об изменениях в пользовательских данных
description: API Microsoft Graph использует механизм веб-перехватчиков для доставки уведомлений клиентам. Клиент — это веб-служба, которая настраивает свой URL-адрес для получения уведомлений. С помощью уведомлений клиентские приложения обновляют свое состояние в случае изменений.
author: baywet
ms.prod: non-product-specific
localization_priority: Priority
ms.custom: graphiamtop20
ms.openlocfilehash: fda8f362d3554f535012bc058ae4a0c7d5ddcfc7
ms.sourcegitcommit: 3834b7b0287ee71668c52c42d3465ca19366e678
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/01/2020
ms.locfileid: "43082352"
---
# <a name="set-up-notifications-for-changes-in-user-data"></a>Настройка уведомлений об изменениях в пользовательских данных

API Microsoft Graph использует механизм веб-перехватчиков для доставки уведомлений клиентам. Клиент — это веб-служба, которая настраивает свой URL-адрес для получения уведомлений. С помощью уведомлений клиентские приложения обновляют свое состояние в случае изменений.

Приняв запрос на подписку, Microsoft Graph отправляет уведомления на URL-адрес, указанный в подписке. Затем приложение действует в соответствии с бизнес-логикой. Например, оно получает дополнительные данные, обновляет кэш и представления, а также выполняет другие действия.


> [!VIDEO https://www.youtube-nocookie.com/embed/rC1bunenaq4]
 
> [!div class="nextstepaction"]
> [Создание приложения веб-перехватчика с помощью .NET Core](/graph/tutorials/change-notifications)

По умолчанию уведомления об изменениях не включают данные ресурсов, кроме `id`. Если приложению требуются данные ресурса, оно может вызвать API Microsoft Graph, чтобы получить ресурс полностью. В этой статье описывается работа с уведомлениями на примере ресурса **user**.

Приложение также может подписаться на уведомления об изменениях, включающие данные ресурсов, чтобы избежать необходимости дополнительного вызова API для доступа к данным. В этом случае приложению необходимо реализовать дополнительный код для обработки требований таких уведомлений, в частности, ответа на уведомления о жизненном цикле подписки, проверки подлинности уведомлений и расшифровки данных ресурсов. Другие типы ресурсов также будут поддерживать этот тип уведомлений в дальнейшем. Дополнительные сведения о работе с такими уведомлениями см. в статье [Настройка уведомлений об изменениях, включающих данные ресурсов (предварительная версия)](webhooks-with-resource-data.md).

## <a name="supported-resources"></a>Поддерживаемые ресурсы

С помощью API Microsoft Graph приложение может подписаться на изменения для следующих ресурсов:

- [Сообщение][] Outlook
- [Событие][] Outlook
- Личный [контакт][] Outlook
- [user][]
- [group][]
- Групповой [чат][] Office 365 
- Контент внутри иерархии _любой папки_ [driveItem][] на персональном хранилище OneDrive пользователя
- Контент внутри иерархии _корневой папки_ [driveItem][] на персональном хранилище OneDrive для бизнеса
- [Оповещение][] безопасности
- Teams [callRecord][] (предварительная версия)

Например, вы можете создать подписку на определенную папку Outlook, например, папку Входящие: `me/mailFolders('inbox')/messages`

либо на ресурс верхнего уровня: `me/messages`, `me/contacts`, `me/events`, `users` или `groups`;

либо на определенный экземпляр ресурса: `users/{id}`, `groups/{id}`, `groups/{id}/conversations`;

либо на личное хранилище OneDrive пользователя: `/drives/{id}/root`
`/drives/{id}/root/subfolder`.

либо на корневую папку диска SharePoint/OneDrive для бизнеса: `/drive/root`

либо на новое оповещение [API безопасности](security-concept-overview.md): `/security/alerts?$filter=status eq 'newAlert'`, `/security/alerts?$filter=vendorInformation/provider eq 'ASC'`

### <a name="azure-ad-resource-limitations"></a>Ограничения ресурсов Azure AD

К ресурсам Azure AD (пользователи, группы) применяются определенные ограничения. В случае их превышения возникают ошибки.

> **Примечание**. Эти ограничения не применяются к ресурсам служб, не относящихся к Azure AD. Например, приложение может создать больше дополнительных подписок на ресурсы `message` или `event`, поддерживаемые службой Exchange Online в составе Microsoft Graph.

- Квоты максимальной подписки:

  - На приложение: 50 000 подписок всего
  - На клиента: 1000 подписок всего во всех приложениях
  - На сочетание приложения и клиента: 100 подписок всего

Если ограничения превышены, попытки создать подписку приведут к [ответу с ошибкой](errors.md) - `403 Forbidden`. Свойство `message` указывает, какое ограничение превышено.

- Клиенты Azure AD B2C не поддерживаются.

- Уведомления для сущностей пользователей не поддерживаются для личных учетных записей Майкрософт.

- В подписках пользователей существует [известная проблема](graph/concepts/known-issues#change-notifications).

### <a name="outlook-resource-limitations"></a>Ограничения ресурсов Outlook

Если вы используете *имя участника-пользователя* на пути к ресурсу при оформлении подписки на ресурсы Outlook, например **сообщения**, **события** или **контакты**, запрос на подписку может быть не выполнен, если это имя содержит апостроф.  Используйте ИД GUID пользователей вместо имен участников-пользователей, чтобы избежать этой проблемы. Например, вместо пути к ресурсу:

`/users/sh.o'neal@contoso.com/messages`

Используйте: 

`/users/{guid-user-id}/messages`

## <a name="subscription-lifetime"></a>Время существования подписки

Время существования подписок ограничено. Приложениям необходимо обновлять подписки до истечения срока их действия. В противном случае им потребуется создавать новые подписки. Список значений, представляющих собой максимально допустимый срок действия, см. в разделе [Максимальный период подписки для каждого из типов ресурсов](/graph/api/resources/subscription?view=graph-rest-1.0#maximum-length-of-subscription-per-resource-type).

Кроме того, приложение в любое время может отменить подписку, чтобы больше не получать уведомления.

## <a name="managing-subscriptions"></a>Управление подписками

Клиенты могут создавать, продлевать и удалять подписки.

### <a name="creating-a-subscription"></a>Создание подписки

Чтобы начать получать уведомления о ресурсе, сначала необходимо создать подписку. Это происходит следующим образом:

1. Клиент отправляет запрос (POST) на подписку для определенного ресурса.

1. Microsoft Graph проверяет запрос.

    - Если запрос является допустимым, Microsoft Graph отправляет маркер проверки на URL-адрес уведомлений.
    - В противном случае Microsoft Graph возвращает сообщение об ошибке с кодом и подробными сведениями.

1. Клиент отправляет маркер проверки в Microsoft Graph.

1. Клиент получает ответ от Microsoft Graph.

Клиент должен хранить идентификатор подписки, чтобы можно было сопоставлять уведомления с подписками.

#### <a name="subscription-request-example"></a>Пример запроса на подписку

```http
POST https://graph.microsoft.com/v1.0/subscriptions
Content-Type: application/json
{
  "changeType": "created,updated",
  "notificationUrl": "https://webhook.azurewebsites.net/notificationClient",
  "resource": "/me/mailfolders('inbox')/messages",
  "expirationDateTime": "2016-03-20T11:00:00.0000000Z",
  "clientState": "SecretClientState"
}
```

Необходимы свойства `changeType`, `notificationUrl`, `resource` и `expirationDateTime`. Определения и значения свойств представлены в [описании типа ресурса подписки](/graph/api/resources/subscription?view=graph-rest-1.0).

Свойство `resource` указывает ресурс, для которого будут отслеживаться изменения. Например, вы можете создать подписку на определенную почтовую папку: `me/mailFolders('inbox')/messages` или сделать это от имени пользователя с согласия администратора: `users/john.doe@onmicrosoft.com/mailFolders('inbox')/messages`.

Хотя свойство `clientState` необязательное, рекомендуем указать его в нашем процессе обработки уведомлений. Задание этого свойства позволит подтверждать, что полученные уведомления поступают от службы Microsoft Graph. По этой причине значение свойства должно оставаться секретным и быть известно только приложению и службе Microsoft Graph.

В случае успешного выполнения Microsoft Graph возвращает код `201 Created` и объект [подписки](/graph/api/resources/subscription?view=graph-rest-1.0) в теле отклика.

#### <a name="notification-endpoint-validation"></a>Проверка конечной точки уведомлений

Прежде чем создавать подписку, Microsoft Graph проверяет конечную точку уведомлений в `notificationUrl` запросе на свойство подписки. Проверка происходит следующим образом:

1. Microsoft Graph отправляет запрос POST на URL-адрес уведомлений:

    ``` http
    Content-Type: text/plain; charset=utf-8
    POST https://{notificationUrl}?validationToken={opaqueTokenCreatedByMicrosoftGraph}
    ```

    > **Важно!** Так как `validationToken` — это параметр запроса, он должен декодироваться клиентом согласно правилам кодирования HTTP. Если клиент не декодирует маркер и использует закодированное значение на следующем шаге (ответ), конечная точка не пройдет проверку. Кроме того, клиент должен рассматривать значение маркера как непрозрачное, так как формат маркера может измениться в будущем без уведомления.

1. В течение 10 секунд клиент должен предоставить ответ со следующими характеристиками:

    - Код состояния 200 (OK).
    - Необходимый тип контента — `text/plain`.
    - Текст должен содержать маркер проверки, предоставленный Microsoft Graph.

Клиент должен удалить маркер проверки после того, как укажет его в отклике.

Кроме того, можно использовать [коллекцию Microsoft Graph Postman](use-postman.md), чтобы убедиться в правильности реализации запроса проверки в вашей конечной точке. Запрос **Проверка подписки** в папке **Прочее** предоставляет модульные тесты, проверяющие отклик вашей конечной точки.  

![результаты теста отклика проверки](images/change-notifications/validation-request-tests-results.png)

### <a name="renewing-a-subscription"></a>Возобновление подписки

Клиент может продлить подписку, указав срок действия до трех дней с момента отправки запроса. Свойство `expirationDateTime` является обязательным.

#### <a name="subscription-renewal-example"></a>Пример возобновления подписки

```http
PATCH https://graph.microsoft.com/v1.0/subscriptions/{id}
Content-Type: application/json

{
  "expirationDateTime": "2016-03-22T11:00:00.0000000Z"
}
```

В случае успешного выполнения Microsoft Graph возвращает код `200 OK` и объект [подписки](/graph/api/resources/subscription?view=graph-rest-1.0) в теле отклика. Объект подписки включает новое значение `expirationDateTime`.

### <a name="deleting-a-subscription"></a>Удаление подписки

Клиент может прекратить получать уведомления, удалив подписку по ее идентификатору.

```http
DELETE https://graph.microsoft.com/v1.0/subscriptions/{id}
```

В случае успешного выполнения Microsoft Graph возвращает код `204 No Content`.

## <a name="notifications"></a>Уведомления

После создания подписки клиент начнет получать уведомления. При изменении ресурса Microsoft Graph отправляет запрос POST на URL-адрес уведомлений. Уведомления отправляются только при изменениях типа, указанного в подписке, например, `created`.

> **Примечание.** Если вы используете несколько подписок, которые отслеживают один тип ресурса и имеют один URL-адрес уведомлений, может быть отправлено сообщение POST, содержащее несколько уведомлений с разными идентификаторами подписок. Уведомления из сообщения POST могут принадлежать разным подпискам.

### <a name="notification-properties"></a>Свойства уведомлений

Объект уведомления содержит следующие свойства:

| Свойство | Тип | Описание |
|:---------|:-----|:------------|
| subscriptionId | строка | Идентификатор подписки, для которого было создано уведомление. |
| subscriptionExpirationDateTime | [дата и время](https://tools.ietf.org/html/rfc3339) | Время окончания срока действия подписки. |
| clientState | строка | `clientState` — свойство, указанное в запросе на подписку (при его наличии). |
| changeType | строка | Тип события, вызвавшего уведомление. Примеры: `created` при получении сообщения или `updated`, когда сообщение помечается как прочитанное. |
| resource | строка | Универсальный код ресурса (URI) ресурса относительно `https://graph.microsoft.com`. |
| resourceData | объект | Содержимое этого свойства зависит от типа связанного с ним ресурса. |
| tenantId | string | Идентификатор клиента, на основе которого получено уведомление. |

Например, для ресурсов Outlook `resourceData` содержит такие поля:

| Свойство | Тип | Описание |
|:---------|:-----|:------------|
| @odata.type | строка | @odata.type — тип сущности OData в Microsoft Graph, который описывает представленный объект. |
| @odata.id | строка | @odata.id — идентификатор OData для объекта. |
| @odata.etag | строка | @odata.etag — HTTP-тег сущности, представляющий версию объекта. |
| id | строка | Идентификатор объекта. |

> **Примечание.** Значение `id`, указанное в `resourceData`, действительно в момент создания уведомления. Некоторые действия, такие как перемещение сообщения в другую папку, могут привести к недействительности `id` во время обработки уведомлений.

### <a name="notification-example"></a>Пример уведомления

Когда пользователь получает электронное письмо, Microsoft Graph отправляет уведомления, аналогичные указанному ниже.

```json
{
  "value": [
    {
      "subscriptionId":"<subscription_guid>",
      "subscriptionExpirationDateTime":"2016-03-19T22:11:09.952Z",
      "clientState":"secretClientValue",
      "changeType":"created",
      "resource":"users/{user_guid}@<tenant_guid>/messages/{long_id_string}",
      "tenantId": "84bd8158-6d4d-4958-8b9f-9d6445542f95",
      "resourceData":
      {
        "@odata.type":"#Microsoft.Graph.Message",
        "@odata.id":"Users/{user_guid}@<tenant_guid>/Messages/{long_id_string}",
        "@odata.etag":"W/\"CQAAABYAAADkrWGo7bouTKlsgTZMr9KwAAAUWRHf\"",
        "id":"<long_id_string>"
      }
    }
  ]
}
```

Обратите внимание, что поле `value` представляет собой массив объектов. Если в очереди много уведомлений, Microsoft Graph может отправлять несколько элементов в одном запросе. В одном запросе уведомления могут содержаться уведомления от разных подписок.

### <a name="processing-the-notification"></a>Обработка уведомления

Необходимо обрабатывать все уведомления, полученные программой. Ниже перечислены основные задачи, которые приложение должно выполнить для обработки уведомления.

1. Отправьте код состояния `202 - Accepted` в ответе, предназначенном Microsoft Graph. Если 2хх код не будет получен, Microsoft Graph попытается опубликовать уведомление несколько раз в течение 4 часов. После этого уведомление будет удалено.

    > **Примечание.** Отправьте код состояния `202 - Accepted` сразу после получения уведомления, еще перед проверкой подлинности. Просто подтвердите получение уведомления, чтобы избежать ненужных повторных попыток.   Текущее значение времени ожидания — 30 секунд, но это время может быть сокращено в будущем для оптимизации производительности службы.

1. Проверьте свойство `clientState`. Оно должно соответствовать значению, отправленному с запросом на создание подписки.

    > **Примечание.** Если это не так, уведомление не следует рассматривать как действительное. Возможно уведомление создано не Microsoft Graph и отправлено незаконным субъектом. Вы также можете определить, откуда поступило уведомление, и выполнить соответствующие действия.

1. Обновляйте приложение в соответствии с бизнес-логикой.

Повторяйте эти действия для других уведомлений в запросе.

## <a name="code-samples"></a>Примеры кода

Указанные ниже примеры кода доступны на сайте GitHub.

- [Обучающий модуль по Microsoft Graph: использование уведомлений об изменениях и отслеживание изменений с помощью Microsoft Graph](https://github.com/microsoftgraph/msgraph-training-changenotifications)
- [Пример веб-перехватчиков Microsoft Graph для Node.js](https://github.com/OfficeDev/Microsoft-Graph-Nodejs-Webhooks)
- [Пример веб-перехватчиков Microsoft Graph для ASP.NET](https://github.com/OfficeDev/Microsoft-Graph-ASPNET-Webhooks)
- [Пример веб-перехватчиков Microsoft Graph для WebJobs SDK](https://github.com/microsoftgraph/webjobs-webhooks-sample)

## <a name="see-also"></a>См. также

- [Тип ресурса subscription](/graph/api/resources/subscription?view=graph-rest-1.0)
- [Получение подписки](/graph/api/subscription-get?view=graph-rest-1.0)
- [Создание подписки](/graph/api/subscription-post-subscriptions?view=graph-rest-1.0)
- [Учебник по уведомлениям об изменениях](/graph/tutorials/change-notifications)
- [Уведомления в жизненном цикле (Предварительная версия)](/graph/concepts/webhooks-outlook-authz.md)

[contact]: /graph/api/resources/contact?view=graph-rest-1.0
[conversation]: /graph/api/resources/conversation?view=graph-rest-1.0
[driveItem]: /graph/api/resources/driveitem?view=graph-rest-1.0
[event]: /graph/api/resources/event?view=graph-rest-1.0
[group]: /graph/api/resources/group?view=graph-rest-1.0
[message]: /graph/api/resources/message?view=graph-rest-1.0
[user]: /graph/api/resources/user?view=graph-rest-1.0
[alert]: /graph/api/resources/alert?view=graph-rest-1.0
[callRecord]: /graph/api/resources/callrecords-callrecord?view=graph-rest-beta
