# <a name="add-custom-data-to-resources-using-extensions"></a>Добавление пользовательских данных в ресурсы с помощью расширений

Microsoft Graph предоставляет одну конечную точку API для доступа к полезным данным и статистике по пользователям с помощью ряда ресурсов, например [user](../api-reference/beta/resources/user.md) и [message](../api-reference/beta/resources/message.md). Теперь существует способ _**расширить**_ Microsoft Graph с помощью собственных данных приложения. Для добавления специальных свойств в ресурсы Microsoft Graph внешнее хранилище данных не нужно. Например, вы можете хранить данные профиля пользователя приложения в Microsoft Graph, дополнив объект **user**. Кроме того, вы можете оставить существующее хранилище для профилей пользователей приложения и просто добавить идентификатор хранилища приложения в ресурс **user**.

В Microsoft Graph есть два типа расширений. Выберите тип с учетом особенностей вашего приложения:

*  **Открытые расширения**. Отличный способ начать для разработчиков.
*  **Расширения схемы**. Более универсальный механизм для разработчиков, которых интересует хранение типизированных данных, возможность совместного доступа к схеме, фильтрации, а также проверки и авторизации входных данных.

>**Важно!** Не используйте расширения для хранения данных учетных записей, государственных идентификационных номеров, данных держателей карт, данных финансовых счетов, медицинских сведений и конфиденциальных биографических данных.

## <a name="supported-resources"></a>Поддерживаемые ресурсы

В следующей таблице показаны ресурсы, для которых поддерживаются открытые расширения и расширения схемы, а также их версия — общедоступная (GA /v1.0 и /beta) или только предварительная (/beta). 

| Ресурс | Открытые расширения | Расширения схемы |
|---------------|-------|-------|
| [Административная единица](../api-reference/beta/resources/administrativeunit.md) | Только предварительная версия | Скоро |
|  [calendar event](../api-reference/beta/resources/event.md) | Общедоступная версия | Только предварительная версия |
|  [calendar event](../api-reference/beta/resources/event.md) для группы | Общедоступная версия | Только предварительная версия |
|  [post](../api-reference/beta/resources/post.md) цепочки беседы группы | Общедоступная версия | Только предварительная версия |
|  [device](../api-reference/beta/resources/device.md) | Только предварительная версия | Только предварительная версия |
|  [group](../api-reference/beta/resources/group.md) | Только предварительная версия | Только предварительная версия |
|  [message](../api-reference/beta/resources/message.md) | Общедоступная версия | Только предварительная версия |
|  [organization](../api-reference/beta/resources/organization.md) | Только предварительная версия | Скоро |
|  [Личный контакт](../api-reference/beta/resources/contact.md)| Общедоступная версия | Скоро |
|  [user](../api-reference/beta/resources/user.md) | Только предварительная версия | Только предварительная версия |

## <a name="open-extensions"></a>Открытые расширения
[Открытые расширения](../api-reference/beta/resources/opentypeextension.md) (прежнее название — расширения данных Office 365) относятся к [открытым типам](http://www.odata.org/getting-started/advanced-tutorial/#openType) и позволяют добавлять нетипизированные данные приложений непосредственно в экземпляр ресурса. 

Открытые расширения, наряду с их пользовательскими данными, доступны через свойство навигации **extensions** экземпляра ресурса. Свойство **extensionName** — это единственное _предварительно определенное_ записываемое свойство в открытом расширении. При создании открытого расширения нужно назначить свойству **extensionName** имя, которое уникально для клиента. Для этого можно использовать обратный формат службы доменных имен (DNS), который зависит от _вашего собственного домена_, например `Com.Contoso.ContactInfo`. Не используйте домен Майкрософт (`Com.Microsoft` или `Com.OnMicrosoft`) в имени расширения.

Вы можете [создать открытое расширение](../api-reference/beta/api/opentypeextension_post_opentypeextension.md) в экземпляре ресурса и сохранить в нем все пользовательские данные с помощью одной операции (обратите внимание на [приведенные ниже ограничения](#known-limitations-for-extensions) для некоторых поддерживаемых ресурсов). Позже вы сможете [считывать](../api-reference/beta/api/opentypeextension_get.md), [обновлять](../api-reference/beta/api/opentypeextension_update.md) или [удалять](../api-reference/beta/api/opentypeextension_delete.md) расширение и его данные. 

>**Примечание.** Кроме событий, публикаций групп, сообщений и личных контактов, открытые расширения теперь доступны для административных единиц, устройств, групп, организаций и пользователей (в предварительной версии).

Пример открытого расширения. [Добавление пользовательских данных в ресурсы user с помощью открытых расширений (предварительная версия)](extensibility_open_users.md)

## <a name="schema-extensions-preview"></a>Расширения схемы (предварительная версия)
[Расширения схемы](../api-reference/beta/resources/schemaextension.md) дают возможность определять схему, используемую для расширения типа ресурса. Вначале нужно создать определение расширения схемы. Затем используйте ее для расширения экземпляров ресурса с помощью строго типизированных пользовательских данных. Кроме того, с помощью свойства [status](#schema-extensions-lifecycle) можно сделать так, чтобы расширение схемы было доступно другим приложениям. Эти приложения смогут использовать расширение для собственных данных и создавать на его основе другие типы взаимодействия.

При создании определения расширения схемы необходимо присвоить уникальное имя его свойству **id**. Есть два варианта:

- Если у вас уже есть личный подтвержденный домен `.com`, уникальное имя может состоять из доменного имени и имени схемы в следующем формате: \{_&#65279;domainName_\}\_\{_&#65279;schemaName_\}. Например, `contoso_mySchema`, если ваш личный домен — contoso.com.  Это предпочтительный способ.
- Если у вас нет подтвержденного личного домена, можете присвоить свойству **id** имя схемы (без префикса в виде доменного имени), например `mySchema`. Microsoft Graph присвоит ему идентификатор строки на основе предоставленного имени в следующем формате: ext\{_&#65279;8-random-alphanumeric-chars_\}\_\{_&#65279;schema-name_\}.  Например, `extkvbmkofy_mySchema`.

Это уникальное имя **id** будет использоваться как имя сложного типа, который будет хранить ваши пользовательские данные в экземпляре расширенного ресурса. 


В отличие от открытых расширений, управление определениями расширений схемы ([list](../api-reference/beta/api/schemaextension_list.md), [create](../api-reference/beta/api/schemaextension_post_schemaextensions.md), [get](../api-reference/beta/api/schemaextension_get.md), [update](../api-reference/beta/api/schemaextension_update.md) и [delete](../api-reference/beta/api/schemaextension_delete.md)) и их данными (добавление, получение, обновление и удаление данных) — это отдельные наборы операций API. 

Так как расширения схемы доступны в виде сложных типов в экземплярах целевых ресурсов, вы можете выполнять операции CRUD с данными в расширении схемы следующими способами:

- Указывать пользовательские данные при создании нового экземпляра ресурса с помощью метода `POST`.
- Читать пользовательские данные с помощью метода `GET`.
- Добавлять или обновлять пользовательские данные в существующем экземпляре ресурса с помощью метода `PATCH`.
- Устанавливать значение null для сложного типа с помощью метода `PATCH` для удаления пользовательских данных в экземпляре ресурса. 

Пример расширения схемы: [Добавление пользовательских данных в ресурсы group с помощью расширений схемы (предварительная версия)](extensibility_schema_groups.md)


### <a name="schema-extensions-lifecycle"></a>Жизненный цикл расширений схемы
Когда приложение создает определение расширения схемы, оно помечается как владелец такого расширения. 

Приложение-владелец может перемещать расширение из одного состояния в другое, используя операцию PATCH для свойства **status**. В зависимости от текущего состояния приложение-владелец может обновлять или удалять расширение. Любые обновления расширения схемы должны всегда быть только дополнительными и не прерывающими.


| Состояние | Поведение в состоянии жизненного цикла |
|-------------|------------|
| InDevelopment | – Начальное состояние после создания. Приложение-владелец все еще разрабатывает расширение схемы. <br> – В этом состоянии только приложение-владелец может использовать расширение схемы. Приложение-владелец может добавлять изменения в определение расширения или удалить его. Только приложение-владелец может расширять экземпляры ресурса с помощью этого определения схемы и только в том каталоге, в котором оно зарегистрировано. <br> – Приложение-владелец может переместить расширение из состояния `InDevelopment` в состояние `Available`. |
| Available | – Расширение схемы доступно для всех приложений в любом клиенте. <br> – Любое приложение может просто добавлять пользовательские данные в экземпляры ресурсов, типы которых указаны в расширении (если у приложения есть соответствующие разрешения). Приложение может назначать пользовательские данные при создании нового экземпляра или обновлении существующего. Только приложение-владелец может добавлять изменения в определение расширения или удалить его. <br> – Приложение-владелец может также переместить расширение схемы из состояния `Available` в состояние `Deprecated`. |
| Deprecated | – Определение расширения схемы больше не доступно для чтения или изменения. <br> – Приложения не могут просматривать, обновлять, добавлять новые свойства или удалить расширение. Но они по-прежнему могут читать, обновлять и удалять _значения свойств_ расширения. <br> – Приложение-владелец может переместить расширение схемы из состояния `Deprecated` обратно в состояние `Available`. |

>**Примечание.** У вас сохраняется доступ к пользовательским данным в расширении схемы в состоянии `Deprecated`. При желании вы можете удалить их. В настоящее время вы можете [потерять доступ](#known-limitations-for-extensions) к своим пользовательским данным после удаления расширения схемы.

### <a name="supported-property-data-types"></a>Поддерживаемые типы данных свойств 
При определении свойства в расширении схемы поддерживаются следующие типы данных:

| Тип свойства | Примечания |
|-------------|------------|
| Binary | Не более 256 байт. |
| Boolean | Не поддерживается для ресурсов message, event и post. |
| DateTime | Должен быть указан в формате ISO 8601. Данные времени будут храниться в формате UTC. |
| Целое число | 32-разрядное значение. Не поддерживается для ресурсов message, event и post. |
| String | Не более 256 символов |

>**Примечание.** В настоящее время многозначные свойства не поддерживаются.

### <a name="azure-ad-directory-schema-extensions"></a>Расширения схемы каталога Azure AD
Azure AD поддерживает схожий тип расширений, известный как [расширения схемы каталога](https://msdn.microsoft.com/en-us/library/azure/ad/graph/howto/azure-ad-graph-api-directory-schema-extensions), для нескольких ресурсов [directoryObject](../api-reference/beta/resources/directoryObject.md). Для создания определений расширений схемы каталога и управления ими необходимо использовать API Graph Azure AD, но вы можете использовать API Graph Microsoft для добавления, получения, обновления и удаления _данных_ в свойствах этих расширений.

## <a name="permissions"></a>Разрешения
Для чтения или записи данных расширений в ресурсе необходимы те же [разрешения](../authorization/permission_scopes.md), что и для чтения или записи ресурса.  Например, чтобы приложение могло добавить данные в профиль пользователя, который вошел в учетную запись, у него должно быть разрешение *User.ReadWrite.All*.

Кроме того, для создания определений расширения схемы и управления ими приложению необходимо разрешение *Directory.AccessAsUser.All*.
 
## <a name="known-limitations-for-extensions"></a>Известные ограничения расширений
-   Невозможно указать открытое расширение при создании экземпляра **administrativeUnit**, **device**, **group**, **organization** или **user**. Сначала необходимо создать экземпляр, а затем указать данные открытого расширения в последующем запросе ``POST`` к этому экземпляру.  
-   Для свойств открытых расширений или расширений схемы не поддерживается отслеживание изменений.
-   Фильтрация по значениям свойств расширения схемы пока не поддерживается.
-   Если удалить определение расширения схемы, доступ к пользовательским данным, добавленным с помощью удаленной схемы, будет потерян. Это временное ограничение.
-   В настоящее время расширение схемы можно удалить в любом состоянии. В будущем удалить расширение схемы можно будет только в состоянии `InDevelopment`.
-   Чтобы удалить из экземпляра ресурса сложный тип расширения схемы, необходимо установить значение `null` для всех свойств сложного типа.  В будущем это можно будет сделать, просто установив значение `null` для сложного типа расширения схемы.
-   В настоящее время таким ресурсам каталога, как user, group и device, можно присвоить не более 100 значений свойств расширений схемы.

## <a name="extension-examples"></a>Примеры расширений
[Добавление пользовательских данных в ресурсы user с помощью открытых расширений (предварительная версия)](extensibility_open_users.md)

[Добавление пользовательских данных в ресурсы group с помощью расширений схемы (предварительная версия)](extensibility_schema_groups.md)

## <a name="see-also"></a>См. также

[Домены Office 365](https://technet.microsoft.com/en-us/library/office-365-domains.aspx)

[Добавление и подтверждение домена для клиента Office 365](http://office365support.ca/adding-and-verifying-a-domain-for-the-new-office-365/)
